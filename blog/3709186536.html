<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>量化分析经典策略总结 | EmoryHuang's Blog</title><meta name="keywords" content="量化分析,经典策略"><meta name="author" content="EmoryHuang"><meta name="copyright" content="EmoryHuang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="量化分析就是将一些不具体，模糊的因素用具体的数据来表示，从而达到分析比较的目的。">
<meta property="og:type" content="article">
<meta property="og:title" content="量化分析经典策略总结">
<meta property="og:url" content="https://emoryhuang.cn/blog/3709186536.html">
<meta property="og:site_name" content="EmoryHuang&#39;s Blog">
<meta property="og:description" content="量化分析就是将一些不具体，模糊的因素用具体的数据来表示，从而达到分析比较的目的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.emoryhuang.cn/webp/3709186536-banner.webp">
<meta property="article:published_time" content="2021-06-10T12:02:34.000Z">
<meta property="article:modified_time" content="2022-08-19T04:59:02.660Z">
<meta property="article:author" content="EmoryHuang">
<meta property="article:tag" content="量化分析">
<meta property="article:tag" content="经典策略">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.emoryhuang.cn/webp/3709186536-banner.webp"><link rel="shortcut icon" href="https://static.emoryhuang.cn/img/emoryhuang-favicon.ico"><link rel="canonical" href="https://emoryhuang.cn/blog/3709186536"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="G-8PVDZZ1XD2"/><meta name="baidu-site-verification" content="c329cbbc3bebfd543905d12a396ae46f"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/favicon-16x16.png"/><link rel="mask-icon" href="/img/siteicon/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4deb492e49dccb8704491045ae2bfb05";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-8PVDZZ1XD2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8PVDZZ1XD2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"ED239XGK05","apiKey":"b13ba7fa60a0bb24a8c61d428d419da2","indexName":"EmoryHuang","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":30,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: EmoryHuang","link":"链接: ","source":"来源: EmoryHuang's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '量化分析经典策略总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-19 12:59:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://static.emoryhuang.cn/js&css/cursor.css"><link rel="stylesheet" href="https://static.emoryhuang.cn/js&css/scroll.css"><link rel="stylesheet" href="https://static.emoryhuang.cn/js&css/fix_pjax.js"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="EmoryHuang's Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/img/emoryhuang-avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">124</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">103</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://home.emoryhuang.cn"><i class="fa-fw fas fa-location-arrow"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 博客</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/chat/"><i class="fa-fw far fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tools/"><i class="fa-fw far fa-bookmark"></i><span> 常用工具</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://latex.emoryhuang.cn"><i class="fa-fw fas fa-square-root-variable"></i><span> LaTeX-Math</span></a></li><li><a class="site-page child" href="/update/"><i class="fa-fw fas fa-edit"></i><span> 网站更新</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://status.emoryhuang.cn"><i class="fa-fw fas fa-chart-line"></i><span> 状态监控</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://static.emoryhuang.cn/webp/3709186536-banner.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">EmoryHuang's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://home.emoryhuang.cn"><i class="fa-fw fas fa-location-arrow"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 博客</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/chat/"><i class="fa-fw far fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tools/"><i class="fa-fw far fa-bookmark"></i><span> 常用工具</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://latex.emoryhuang.cn"><i class="fa-fw fas fa-square-root-variable"></i><span> LaTeX-Math</span></a></li><li><a class="site-page child" href="/update/"><i class="fa-fw fas fa-edit"></i><span> 网站更新</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://status.emoryhuang.cn"><i class="fa-fw fas fa-chart-line"></i><span> 状态监控</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">量化分析经典策略总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-10T12:02:34.000Z" title="发表于 2021-06-10 20:02:34">2021-06-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-19T04:59:02.660Z" title="更新于 2022-08-19 12:59:02">2022-08-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90/">量化分析</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">28k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>108分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="量化分析经典策略总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note info flat"><p>本文转载自：<a target="_blank" rel="noopener" href="https://www.myquant.cn/docs/python_strategyies/">掘金量化</a></p>
</div>
<h1>量化分析经典策略总结</h1>
<h2 id="菲阿里四价-期货">菲阿里四价(期货)</h2>
<h3 id="原理">原理</h3>
<p>菲阿里四价同 R Breaker 一样，也是一种 <strong>日内</strong> 策略交易，适合短线投资者。</p>
<p>菲阿里四价指的是：昨日高点、昨日低点、昨天收盘、今天开盘四个价格。</p>
<p>菲阿里四价上下轨的计算非常简单。昨日高点为上轨，昨日低点为下轨。当价格突破上轨时，买入开仓；当价格突破下轨时，卖出开仓。</p>
<h3 id="策略逻辑">策略逻辑</h3>
<p>第一步：获取昨日最高价、最低价、收盘价、开盘价四个数据。</p>
<p>第二步：计算上轨和下轨。当价格上穿上轨时，买入开仓；当价格下穿下轨时，卖出开仓。</p>
<p>第三步：当日平仓。</p>
<h3 id="策略代码">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">上轨=昨日最高点；</span></span><br><span class="line"><span class="string">下轨=昨日最低点；</span></span><br><span class="line"><span class="string">止损=今日开盘价;</span></span><br><span class="line"><span class="string">如果没有持仓，且现价大于了昨天最高价做多，小于昨天最低价做空。</span></span><br><span class="line"><span class="string">如果有多头持仓，当价格跌破了开盘价止损。</span></span><br><span class="line"><span class="string">如果有空头持仓，当价格上涨超过开盘价止损。</span></span><br><span class="line"><span class="string">选取 进行了回测。</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">1：为回测方便，本策略使用了on_bar的一分钟来计算，实盘中可能需要使用on_tick。</span></span><br><span class="line"><span class="string">2：实盘中，如果在收盘的那一根bar或tick触发交易信号，需要自行处理，实盘可能不会成交。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 设置标的</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHFE.rb2010&#x27;</span></span><br><span class="line">    <span class="comment"># 订阅一分钟线</span></span><br><span class="line">    subscribe(symbols = context.symbol,frequency = <span class="string">&#x27;60s&#x27;</span>,count = <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 记录开仓次数，保证一天只开仓一次</span></span><br><span class="line">    context.count = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 记录当前时间</span></span><br><span class="line">    time = context.now.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>)</span><br><span class="line">    <span class="comment"># 如果当前时间点是交易时间段，则直接执行algo获取历史数据，以防直接进入on_bar()导致context.history_data未定义</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;09:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;15:00:00&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;21:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;23:00:00&#x27;</span>:</span><br><span class="line">        algo(context)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是非交易时间段，等到上午9点或晚上21点再执行algo()</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;09:00:00&#x27;</span>)</span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;21:00:00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 获取历史的n条信息</span></span><br><span class="line">    context.history_data = history_n(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, end_time=context.now,</span><br><span class="line">                                     fields=<span class="string">&#x27;symbol,open,high,low&#x27;</span>, count=<span class="number">2</span>, df=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context,bars</span>):</span><br><span class="line">    <span class="comment"># 取出订阅的一分钟bar</span></span><br><span class="line">    bar = bars[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取数据</span></span><br><span class="line">    data = context.history_data</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 现有持仓情况</span></span><br><span class="line">    position_long = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line">    position_short = context.account().position(symbol=context.symbol, side=PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是回测模式</span></span><br><span class="line">    <span class="keyword">if</span> context.mode == <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># 开盘价直接在data最后一个数据里取到,前一交易日的最高和最低价为history_data里面的倒数第二条中取到</span></span><br><span class="line">        <span class="built_in">open</span> = data.loc[<span class="number">1</span>, <span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">        high = data.loc[<span class="number">0</span>, <span class="string">&#x27;high&#x27;</span>]</span><br><span class="line">        low = data.loc[<span class="number">0</span>, <span class="string">&#x27;low&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是实时模式</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 开盘价通过current取到</span></span><br><span class="line">        <span class="built_in">open</span> = current(context.symbol)[<span class="number">0</span>][<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">        <span class="comment"># 实时模式不会返回当天的数据，所以history_data里面的最后一条数据是前一交易日的数据</span></span><br><span class="line">        high = data.loc[-<span class="number">1</span>, <span class="string">&#x27;high&#x27;</span>]</span><br><span class="line">        low = data.loc[-<span class="number">1</span>, <span class="string">&#x27;low&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交易逻辑部分</span></span><br><span class="line">    <span class="keyword">if</span> position_long:  <span class="comment"># 多头持仓小于开盘价止损。</span></span><br><span class="line">        <span class="keyword">if</span> bar.close &lt; <span class="built_in">open</span>:</span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;以市价单平多仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> position_short:<span class="comment"># 空头持仓大于开盘价止损。</span></span><br><span class="line">        <span class="keyword">if</span> bar.close &gt; <span class="built_in">open</span>:</span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;以市价单平空仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># 没有持仓</span></span><br><span class="line">        <span class="keyword">if</span> bar.close &gt; high <span class="keyword">and</span> <span class="keyword">not</span> context.count:  <span class="comment"># 当前的最新价大于了前一天的最高价</span></span><br><span class="line">            <span class="comment"># 开多</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;以市价单开多仓&#x27;</span>)</span><br><span class="line">            context.count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> bar.close &lt; low <span class="keyword">and</span> <span class="keyword">not</span> context.count:  <span class="comment"># 当前最新价小于了前一天的最低价</span></span><br><span class="line">            <span class="comment"># 开空</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;以市价单开空仓&#x27;</span>)</span><br><span class="line">            context.count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 每天收盘前一分钟平仓</span></span><br><span class="line">    <span class="keyword">if</span> context.now.hour == <span class="number">14</span> <span class="keyword">and</span> context.now.minute == <span class="number">59</span>:</span><br><span class="line">        order_close_all()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;全部平仓&#x27;</span>)</span><br><span class="line">        context.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2020-01-01 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-09-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">100000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="双均线策略-期货">双均线策略(期货)</h2>
<h3 id="原理-2">原理</h3>
<p>从统计角度来说，均线就是历史价格的平均值，可以代表过去 N 日股价的平均走势。</p>
<p>Granville 八大法则其中有四条是用于判断买进时机，另外四条是用于判断卖出时机。买进和卖出法则一一对应，分布在高点的左右两侧（除买 4 和卖 4 以外）。法则内容如下所示：</p>
<ul>
<li>
<p>买 1：均线整体上行，股价由下至上上穿均线，此为黄金交叉，形成第一个买点。</p>
</li>
<li>
<p>买 2：股价出现下跌迹象，但尚未跌破均线，此时均线变成支撑线，形成第二个买点。</p>
</li>
<li>
<p>买 3：股价仍处于均线上方，但呈现急剧下跌趋势。当跌破均线时，出现第三个买点。</p>
</li>
<li>
<p>买 4：（右侧）股价和均线都处于下降通道，且股价处于均线下方，严重远离均线，出现第四个买点。</p>
</li>
<li>
<p>卖 1：均线由上升状态变为缓慢下降的状态，股价也开始下降。当股价跌破均线时，此为死亡交叉，形成第一个卖点。</p>
</li>
<li>
<p>卖 2：股价仍处于均线之下，但股价开始呈现上涨趋势，当股价无限接近均线但尚未突破时，此时均线变成阻力线，形成第二个卖点。</p>
</li>
<li>
<p>卖 3：股价终于突破均线，处于均线上方。但持续时间不长，股价开始下跌，直至再一次跌破均线，此为第三个卖点。</p>
</li>
<li>
<p>卖 4：（左侧）股价和均线都在上涨，股价上涨的速度远快于均线上涨的速度。当股价严重偏离均线时，出现第四个卖点。</p>
</li>
</ul>
<h4 id="均线理论为什么有效？">均线理论为什么有效？</h4>
<p>Shiller（1981）在研究中发现，资产的长期价格呈现均值回复的特征，即从长期来看，资产的价格会回归均值。这也是均线理论被广泛应用的前提。</p>
<h4 id="均线理论的缺陷">均线理论的缺陷</h4>
<p>均线归根到底是一种平均值，平均值在应用过程中存在最大的问题就是其滞后性。当出现买入卖出信号时，最佳时机早已过去。</p>
<h4 id="均线理论的改进">均线理论的改进</h4>
<ol>
<li>对均线的计算方法进行改正。</li>
</ol>
<p>加权移动平均线是在移动平均线的基础上按照时间进行加权。越靠近当前日期的价格对未来价格的影响越大，赋予更大的权重；越远离当前日期价格，赋予越小的权重。</p>
<ol start="2">
<li>调整均线周期</li>
</ol>
<p>利用不同周期均线得到的结果也不同。</p>
<h3 id="策略逻辑-2">策略逻辑</h3>
<p>第一步：获取数据，计算长短期均线<br>
第二步：设置交易信号</p>
<ul>
<li>当短期均线由上向下穿越长期均线时做空</li>
<li>当短期均线由下向上穿越长期均线时做多</li>
</ul>
<h3 id="策略代码-2">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> talib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略以SHFE.rb2101为交易标的，根据其一分钟(即60s频度）bar数据建立双均线模型，</span></span><br><span class="line"><span class="string">短周期为20，长周期为60，当短期均线由上向下穿越长期均线时做空，</span></span><br><span class="line"><span class="string">当短期均线由下向上穿越长期均线时做多,每次开仓前先平掉所持仓位，再开仓。</span></span><br><span class="line"><span class="string">注：为了适用于仿真和实盘，在策略中增加了一个“先判断是否平仓成功再开仓”的判断逻辑，以避免出现未平仓成功，可用资金不足的情况。</span></span><br><span class="line"><span class="string">回测数据为:SHFE.rb2101的60s频度bar数据</span></span><br><span class="line"><span class="string">回测时间为:2020-04-01 09:00:00到2020-05-31 15:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    context.short = <span class="number">20</span>                                             <span class="comment"># 短周期均线</span></span><br><span class="line">    context.long = <span class="number">60</span>                                              <span class="comment"># 长周期均线</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHFE.rb2101&#x27;</span>                                 <span class="comment"># 订阅交易标的</span></span><br><span class="line">    context.period = context.long + <span class="number">1</span>                              <span class="comment"># 订阅数据滑窗长度</span></span><br><span class="line">    context.open_long = <span class="literal">False</span>                                      <span class="comment"># 开多单标记</span></span><br><span class="line">    context.open_short = <span class="literal">False</span>                                     <span class="comment"># 开空单标记</span></span><br><span class="line">    subscribe(context.symbol, <span class="string">&#x27;60s&#x27;</span>, count=context.period)         <span class="comment"># 订阅行情</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 获取通过subscribe订阅的数据</span></span><br><span class="line">    prices = context.data(context.symbol, <span class="string">&#x27;60s&#x27;</span>, context.period, fields=<span class="string">&#x27;close&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 利用talib库计算长短周期均线</span></span><br><span class="line">    short_avg = talib.SMA(prices.values.reshape(context.period), context.short)</span><br><span class="line">    long_avg = talib.SMA(prices.values.reshape(context.period), context.long)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询持仓</span></span><br><span class="line">    position_long = context.account().position(symbol=context.symbol, side=<span class="number">1</span>)</span><br><span class="line">    position_short = context.account().position(symbol=context.symbol, side=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 短均线下穿长均线，做空(即当前时间点短均线处于长均线下方，前一时间点短均线处于长均线上方)</span></span><br><span class="line">    <span class="keyword">if</span> long_avg[-<span class="number">2</span>] &lt; short_avg[-<span class="number">2</span>] <span class="keyword">and</span> long_avg[-<span class="number">1</span>] &gt;= short_avg[-<span class="number">1</span>]:</span><br><span class="line">        <span class="comment"># 无多仓情况下，直接开空</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> position_long:</span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell, position_effect=PositionEffect_Open, order_type=OrderType_Market)</span><br><span class="line">            <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单调空仓到仓位&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 有多仓情况下，先平多，再开空(开空命令放在on_order_status里面)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            context.open_short = <span class="literal">True</span></span><br><span class="line">            <span class="comment"># 以市价平多仓</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell, position_effect=PositionEffect_Close, order_type=OrderType_Market)</span><br><span class="line">            <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单平多仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 短均线上穿长均线，做多（即当前时间点短均线处于长均线上方，前一时间点短均线处于长均线下方）</span></span><br><span class="line">    <span class="keyword">if</span> short_avg[-<span class="number">2</span>] &lt; long_avg[-<span class="number">2</span>] <span class="keyword">and</span> short_avg[-<span class="number">1</span>] &gt;= long_avg[-<span class="number">1</span>]:</span><br><span class="line">        <span class="comment"># 无空仓情况下，直接开多</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> position_short:</span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy, position_effect=PositionEffect_Open, order_type=OrderType_Market)</span><br><span class="line">            <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单调多仓到仓位&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 有空仓的情况下，先平空，再开多(开多命令放在on_order_status里面)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            context.open_long = <span class="literal">True</span></span><br><span class="line">            <span class="comment"># 以市价平空仓</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy,</span><br><span class="line">                         position_effect=PositionEffect_Close, order_type=OrderType_Market)</span><br><span class="line">            <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单平空仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_order_status</span>(<span class="params">context, order</span>):</span><br><span class="line">    <span class="comment"># 查看下单后的委托状态</span></span><br><span class="line">    status = order[<span class="string">&#x27;status&#x27;</span>]</span><br><span class="line">    <span class="comment"># 成交命令的方向</span></span><br><span class="line">    side = order[<span class="string">&#x27;side&#x27;</span>]</span><br><span class="line">    <span class="comment"># 交易类型</span></span><br><span class="line">    effect = order[<span class="string">&#x27;position_effect&#x27;</span>]</span><br><span class="line">    <span class="comment"># 当平仓委托全成后，再开仓</span></span><br><span class="line">    <span class="keyword">if</span> status == <span class="number">3</span>:</span><br><span class="line">        <span class="comment"># 以市价开空仓，需等到平仓成功无仓位后再开仓</span></span><br><span class="line">        <span class="comment"># 如果无多仓且side=2（说明平多仓成功），开空仓</span></span><br><span class="line">        <span class="keyword">if</span> effect == <span class="number">2</span> <span class="keyword">and</span> side == <span class="number">2</span> <span class="keyword">and</span> context.open_short:</span><br><span class="line">            context.open_short = <span class="literal">False</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell, position_effect=PositionEffect_Open, order_type=OrderType_Market)</span><br><span class="line">            <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单调空仓到仓位&#x27;</span>)</span><br><span class="line">        <span class="comment"># 以市价开多仓,需等到平仓成功无仓位后再开仓</span></span><br><span class="line">        <span class="comment"># 如果无空仓且side=1（说明平空仓成功），开多仓</span></span><br><span class="line">        <span class="keyword">if</span> effect == <span class="number">2</span> <span class="keyword">and</span> side == <span class="number">1</span> <span class="keyword">and</span> context.open_long:</span><br><span class="line">            context.open_long = <span class="literal">False</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy, position_effect=PositionEffect_Open, order_type=OrderType_Market)</span><br><span class="line">            <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单调多仓到仓位&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">        filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">        mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">        token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">        backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">        backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">        backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">        backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">        backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">        backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2020-04-01 09:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-05-31 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_NONE,</span><br><span class="line">        backtest_initial_cash=<span class="number">10000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Dual-Thrust-期货">Dual Thrust(期货)</h2>
<h3 id="原理-3">原理</h3>
<p>其核心思想是定义一个区间，区间的上界和下界分别为支撑线和阻力线。当价格超过上界时，如果持有空仓，先平再开多；如果没有仓位，直接开多。当价格跌破下界时，如果持有多仓，则先平仓，再开空仓；如果没有仓位，直接开空仓。</p>
<p>上下界的设定是交易策略的核心部分。在计算上下界时共用到：最高价、最低价、收盘价、开盘价四个参数。</p>
<p>公式如下：</p>
<p>Range = Max(HH - LC, HC - LL)</p>
<p>max(最大最高价(HH) - 最小收盘价(LC)，最大收盘价(HC) - 最小最低价(LL))</p>
<p>上限：Open + K1 * Range</p>
<p>下限：Open - k2 * Range</p>
<p>K1 和 K2 一般根据自己经验以及回测结果进行优化。</p>
<h3 id="策略逻辑-3">策略逻辑</h3>
<p>第一步：设置参数 N、k1、k2</p>
<p>第二步：计算 HH、LC、HC、LL</p>
<p>第三步：计算 range</p>
<p>第四步：设定做多和做空信号</p>
<h3 id="策略代码-3">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Dual Thrust是一个趋势跟踪系统</span></span><br><span class="line"><span class="string">计算前N天的最高价－收盘价和收盘价－最低价。然后取这2N个价差的最大值，乘以k值。把结果称为触发值。</span></span><br><span class="line"><span class="string">在今天的开盘，记录开盘价，然后在价格超过上轨（开盘＋触发值）时马上买入，或者价格低于下轨（开盘－触发值）时马上卖空。</span></span><br><span class="line"><span class="string">没有明确止损。这个系统是反转系统，也就是说，如果在价格超过（开盘＋触发值）时手头有空单，则平空开多。</span></span><br><span class="line"><span class="string">同理，如果在价格低于（开盘－触发值）时手上有多单，则平多开空。</span></span><br><span class="line"><span class="string">选用了SHFE的rb2010 在2020-02-07 15:00:00 到 2020-04-15 15:00:00&#x27; 进行回测。</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">1：为回测方便，本策略使用了on_bar的一分钟来计算，实盘中可能需要使用on_tick。</span></span><br><span class="line"><span class="string">2：实盘中，如果在收盘的那一根bar或tick触发交易信号，需要自行处理，实盘可能不会成交</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 策略中必须有init方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 设置要进行回测的合约（可以在掘金终端的仿真交易中查询标的代码）</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHFE.rb2010&#x27;</span>  <span class="comment"># 订阅&amp;交易标的, 此处订阅的是上期所的螺纹钢 2010</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置参数</span></span><br><span class="line">    context.N = <span class="number">5</span></span><br><span class="line">    context.k1 = <span class="number">0.2</span></span><br><span class="line">    context.k2 = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当前时间</span></span><br><span class="line">    time = context.now.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果策略执行时间点是交易时间段，则直接执行algo定义buy_line和sell_line，以防直接进入on_bar()导致context.buy_line和context.sell_line未定义</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;09:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;15:00:00&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;21:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;23:00:00&#x27;</span>:</span><br><span class="line">        algo(context)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是交易时间段，等到开盘时间确保进入algo()</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;09:00:00&#x27;</span>)</span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;21:00:00&#x27;</span>)</span><br><span class="line">    <span class="comment"># 只需要最新价，所以只需要订阅一个, 如果用tick，次数太多，用一分钟线代替</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 取历史数据</span></span><br><span class="line">    data = history_n(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, end_time=context.now,</span><br><span class="line">                     fields=<span class="string">&#x27;symbol,open,high,low,close&#x27;</span>, count=context.N + <span class="number">1</span>, df=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 取开盘价</span></span><br><span class="line">    <span class="comment"># 回测模式下，开盘价可以直接用history_n取到</span></span><br><span class="line">    <span class="keyword">if</span> context.mode == <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># 获取当天的开盘价</span></span><br><span class="line">        current_open = data.<span class="built_in">open</span>.loc[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># 去掉当天的实时数据</span></span><br><span class="line">        data.drop(context.N, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是实时模式，开盘价需要用current取到</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 获取当天的开盘价</span></span><br><span class="line">        current_open = current(context.symbol)[<span class="number">0</span>][<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算Dual Thrust 的上下轨</span></span><br><span class="line">    HH = data[<span class="string">&#x27;high&#x27;</span>].<span class="built_in">max</span>()</span><br><span class="line">    HC = data[<span class="string">&#x27;close&#x27;</span>].<span class="built_in">max</span>()</span><br><span class="line">    LC = data[<span class="string">&#x27;close&#x27;</span>].<span class="built_in">min</span>()</span><br><span class="line">    LL = data[<span class="string">&#x27;low&#x27;</span>].<span class="built_in">min</span>()</span><br><span class="line">    <span class="built_in">range</span> = <span class="built_in">max</span>(HH - LC, HC - LL)</span><br><span class="line">    context.buy_line = current_open + <span class="built_in">range</span> * context.k1  <span class="comment"># 上轨</span></span><br><span class="line">    context.sell_line = current_open - <span class="built_in">range</span> * context.k2  <span class="comment"># 下轨</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 取出订阅的这一分钟的bar</span></span><br><span class="line">    bar = bars[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取出买卖线</span></span><br><span class="line">    buy_line = context.buy_line</span><br><span class="line">    sell_line = context.sell_line</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取现有持仓</span></span><br><span class="line">    position_long = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line">    position_short = context.account().position(symbol=context.symbol, side=PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交易逻辑部分</span></span><br><span class="line">    <span class="comment"># 如果超过range的上界</span></span><br><span class="line">    <span class="keyword">if</span> bar.close &gt; buy_line:</span><br><span class="line">        <span class="keyword">if</span> position_long:  <span class="comment"># 已经持有多仓，直接返回</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> position_short:  <span class="comment"># 已经持有空仓，平仓再做多。</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平空仓&#x27;</span>, context.symbol)</span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单开多仓&#x27;</span>, context.symbol)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 没有持仓时，市价开多。</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单开多仓&#x27;</span>, context.symbol)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果低于range的下界</span></span><br><span class="line">    <span class="keyword">elif</span> bar.close &lt; sell_line:</span><br><span class="line">        <span class="keyword">if</span> position_long:  <span class="comment"># 已经持有多仓， 平多再开空。</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平多仓&#x27;</span>, context.symbol)</span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单开空仓&#x27;</span>, context.symbol)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> position_short:  <span class="comment"># 已经持有空仓，直接返回。</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 没有持仓，直接开空</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">1</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单开空仓&#x27;</span>, context.symbol)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">        filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">        mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">        token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">        backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">        backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">        backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">        backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">        backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">        backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2020-02-07 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-04-15 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_initial_cash=<span class="number">30000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="R-Breaker-期货">R-Breaker(期货)</h2>
<h3 id="原理-4">原理</h3>
<h4 id="原理-5">原理</h4>
<p>R Breaker 是一种 <strong>日内</strong> 回转交易策略，属于短线交易。日内回转交易是指当天买入或卖出标的后于当日再卖出或买入标的。日内回转交易通过标的短期波动盈利，低买高卖，时间短、投机性强，适合短线投资者。</p>
<p>R Breaker 主要分为分为反转和趋势两部分。空仓时进行趋势跟随，持仓时等待反转信号反向开仓。</p>
<p>由于我国 A 股采用的是“T+1”交易制度，为了方便起见，以期货为例演示 R Breaker 策略。</p>
<p>反转和趋势突破的价位点根据前一交易日的收盘价、最高价和最低价数据计算得出，分别为：突破买入价、观察卖出价、反转卖出价、反转买入价、观察买入价和突破卖出价。计算方法如下：</p>
<p>指标计算方法：</p>
<ul>
<li>中心价位 P = （H + C + L）/3</li>
<li>突破买入价 = H + 2P -2L</li>
<li>观察卖出价 = P + H - L</li>
<li>反转卖出价 = 2P - L</li>
<li>反转买入价 = 2P - H</li>
<li>观察买入价 = P - (H - L)</li>
<li>突破卖出价 = L - 2(H - P)</li>
</ul>
<p>（H: 最高价, C: 收盘价, L: 最低价）</p>
<h4 id="触发条件">触发条件</h4>
<p>空仓时：突破策略</p>
<ul>
<li>空仓时，当盘中价格&gt;突破买入价，则认为上涨的趋势还会继续，开仓做多；</li>
<li>空仓时，当盘中价格&lt;突破卖出价，则认为下跌的趋势还会继续，开仓做空。</li>
</ul>
<p>持仓时：反转策略</p>
<ul>
<li>持多单时：当日内最高价&gt;观察卖出价后，盘中价格回落，跌破反转卖出价构成的支撑线时，采取反转策略，即做空；</li>
<li>持空单时：当日内最低价&lt;观察买入价后，盘中价格反弹，超过反转买入价构成的阻力线时，采取反转策略，即做多。</li>
</ul>
<h4 id="背后逻辑解析">背后逻辑解析</h4>
<ul>
<li>前一交易日 K 线越长，下影线越长，突破买入价越高。</li>
<li>前一交易日 K 线越长，上影线越长，突破卖入价越高。</li>
</ul>
<p>当今日的价格突破前一交易日的最高点，形态上来看会是上涨趋势，具备一定的开多仓条件，但还不够。若前一交易日的下影线越长，说明多空方博弈激烈，多方力量强大。因此可以设置更高的突破买入价，一旦突破说明多方力量稳稳地占据了上风，那么就有理由相信未来会继续上涨。同理可解释突破卖出价背后的逻辑。</p>
<p>持有多仓时，若标的价格持续走高，则在当天收盘之前平仓获利离场。若价格不升反降，跌破观察卖出价时，此时价格仍处于前一交易日最高价之上，继续观望。若继续下跌，直到跌破反转卖出价时，平仓止损。</p>
<p>持有空仓时，若标的价格持续走低，则在当天收盘之前平仓获利离场。若价格不降反升，升至观察买入价时，此时价格仍处于前一交易日最低价之下，继续观望。若继续上涨，直到升至反转买入价时，平仓止损。</p>
<h3 id="策略逻辑-4">策略逻辑</h3>
<p>第一步：根据收盘价、最高价和最低价数据计算六个价位。</p>
<p>第二步：如果是空仓条件下，如果价格超过突破买入价，则开多仓；如果价格跌破突破卖出价，则开空仓。</p>
<p>第三步：在持仓条件下:</p>
<ul>
<li>持多单时，当最高价超过观察卖出价，盘中价格进一步跌破反转卖出价，反手做空；</li>
<li>持空单时，当最低价低于观察买入价，盘中价格进一步超过反转买入价，反手做多。</li>
</ul>
<p>第四步：接近收盘时，全部平仓。</p>
<h3 id="策略代码-4">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">R-Breaker是一种短线日内交易策略</span></span><br><span class="line"><span class="string">根据前一个交易日的收盘价、最高价和最低价数据通过一定方式计算出六个价位，从大到小依次为：</span></span><br><span class="line"><span class="string">突破买入价、观察卖出价、反转卖出价、反转买入、观察买入价、突破卖出价。以此来形成当前交易</span></span><br><span class="line"><span class="string">日盘中交易的触发条件。</span></span><br><span class="line"><span class="string">追踪盘中价格走势，实时判断触发条件。具体条件如下：</span></span><br><span class="line"><span class="string">突破</span></span><br><span class="line"><span class="string">在空仓条件下，如果盘中价格超过突破买入价，则采取趋势策略，即在该点位开仓做多。</span></span><br><span class="line"><span class="string">在空仓条件下，如果盘中价格跌破突破卖出价，则采取趋势策略，即在该点位开仓做空。</span></span><br><span class="line"><span class="string">反转</span></span><br><span class="line"><span class="string">持多单，当日内最高价超过观察卖出价后，盘中价格出现回落，且进一步跌破反转卖出价构成的支撑线时，采取反转策略，即在该点位反手做空。</span></span><br><span class="line"><span class="string">持空单，当日内最低价低于观察买入价后，盘中价格出现反弹，且进一步超过反转买入价构成的阻力线时，采取反转策略，即在该点位反手做多。</span></span><br><span class="line"><span class="string">设定止损条件。当亏损达到设定值后，平仓。</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">1：为回测方便，本策略使用了on_bar的一分钟来计算，实盘中可能需要使用on_tick。</span></span><br><span class="line"><span class="string">2：实盘中，如果在收盘的那一根bar或tick触发交易信号，需要自行处理，实盘可能不会成交。</span></span><br><span class="line"><span class="string">3：本策略使用在15点收盘时全平的方式来处理不持有隔夜单的情况，实际使用中15点是无法平仓的。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 设置交易品种</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHFE.ag&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置止损点数</span></span><br><span class="line">    context.stopLossPrice = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取前一交易日的主力合约</span></span><br><span class="line">    startDate = get_previous_trading_date(exchange=<span class="string">&#x27;SHFE&#x27;</span>, date=context.now.date())</span><br><span class="line">    continuous_contract = get_continuous_contracts(context.symbol, startDate, startDate)</span><br><span class="line">    context.mainContract = continuous_contract[<span class="number">0</span>][<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当前时间</span></span><br><span class="line">    time = context.now.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果当前时间是非交易时间段，则直接执行algo,以防直接进入on_bar()导致context.bBreak等未定义</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;09:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;15:00:00&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;21:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;23:00:00&#x27;</span>:</span><br><span class="line">        algo(context)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是交易时间段，等到开盘时间确保进入algo()</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;09:00:00&#x27;</span>)</span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;21:00:00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 订阅行情</span></span><br><span class="line">    subscribe(continuous_contract[<span class="number">0</span>][<span class="string">&#x27;symbol&#x27;</span>], frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 检查主力和约，发生变化则更换订阅</span></span><br><span class="line">    <span class="comment"># 由于主力合约在盘后才公布，为了防止未来函数，选择上一交易日的主力合约。</span></span><br><span class="line">    startDate = get_previous_trading_date(exchange=<span class="string">&#x27;SHFE&#x27;</span>, date=context.now.date())</span><br><span class="line">    contractInfo = get_continuous_contracts(context.symbol, startDate, startDate)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> context.mainContract != contractInfo[<span class="number">0</span>][<span class="string">&#x27;symbol&#x27;</span>]:</span><br><span class="line">        context.mainContract = contractInfo[<span class="number">0</span>][<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        subscribe(context.mainContract, frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">1</span>, unsubscribe_previous=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取历史数据</span></span><br><span class="line">    data = history_n(symbol=context.mainContract, frequency=<span class="string">&#x27;1d&#x27;</span>,</span><br><span class="line">                     end_time=context.now, fields=<span class="string">&#x27;high,low,open,symbol,close&#x27;</span>, count=<span class="number">2</span>, df=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    high = data[<span class="string">&#x27;high&#x27;</span>].iloc[<span class="number">0</span>]  <span class="comment"># 前一日的最高价</span></span><br><span class="line">    low = data[<span class="string">&#x27;low&#x27;</span>].iloc[<span class="number">0</span>]  <span class="comment"># 前一日的最低价</span></span><br><span class="line">    close = data[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>]  <span class="comment"># 前一日的收盘价</span></span><br><span class="line">    pivot = (high + low + close) / <span class="number">3</span>  <span class="comment"># 枢轴点</span></span><br><span class="line"></span><br><span class="line">    context.bBreak = high + <span class="number">2</span> * (pivot - low)  <span class="comment"># 突破买入价</span></span><br><span class="line">    context.sSetup = pivot + (high - low)  <span class="comment"># 观察卖出价</span></span><br><span class="line">    context.sEnter = <span class="number">2</span> * pivot - low  <span class="comment"># 反转卖出价</span></span><br><span class="line">    context.bEnter = <span class="number">2</span> * pivot - high  <span class="comment"># 反转买入价</span></span><br><span class="line">    context.bSetup = pivot - (high - low)  <span class="comment"># 观察买入价</span></span><br><span class="line">    context.sBreak = low - <span class="number">2</span> * (high - pivot)  <span class="comment"># 突破卖出价</span></span><br><span class="line">    context.data = data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 获取止损价</span></span><br><span class="line">    STOP_LOSS_PRICE = context.stopLossPrice</span><br><span class="line">    <span class="comment"># 设置参数</span></span><br><span class="line">    bBreak = context.bBreak</span><br><span class="line">    sSetup = context.sSetup</span><br><span class="line">    sEnter = context.sEnter</span><br><span class="line">    bEnter = context.bEnter</span><br><span class="line">    bSetup = context.bSetup</span><br><span class="line">    sBreak = context.sBreak</span><br><span class="line">    data = context.data</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取现有持仓</span></span><br><span class="line">    position_long = context.account().position(symbol=context.mainContract, side=PositionSide_Long)</span><br><span class="line">    position_short = context.account().position(symbol=context.mainContract, side=PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 突破策略:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position_long <span class="keyword">and</span> <span class="keyword">not</span> position_short:  <span class="comment"># 空仓条件下</span></span><br><span class="line">        <span class="keyword">if</span> bars[<span class="number">0</span>].close &gt; bBreak:</span><br><span class="line">            <span class="comment"># 在空仓的情况下，如果盘中价格超过突破买入价，则采取趋势策略，即在该点位开仓做多</span></span><br><span class="line">            order_volume(symbol=context.mainContract, volume=<span class="number">10</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)  <span class="comment"># 做多</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;空仓,盘中价格超过突破买入价: 开仓做多&quot;</span>)</span><br><span class="line">            context.open_position_price = bars[<span class="number">0</span>].close</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> bars[<span class="number">0</span>].close &lt; sBreak:</span><br><span class="line">            <span class="comment"># 在空仓的情况下，如果盘中价格跌破突破卖出价，则采取趋势策略，即在该点位开仓做空</span></span><br><span class="line">            order_volume(symbol=context.mainContract, volume=<span class="number">10</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)  <span class="comment"># 做空</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;空仓,盘中价格跌破突破卖出价: 开仓做空&quot;</span>)</span><br><span class="line"></span><br><span class="line">            context.open_position_price = bars[<span class="number">0</span>].close</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置止损条件</span></span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># 有持仓时</span></span><br><span class="line">        <span class="comment"># 开仓价与当前行情价之差大于止损点则止损</span></span><br><span class="line">        <span class="keyword">if</span> (position_long <span class="keyword">and</span> context.open_position_price - bars[<span class="number">0</span>].close &gt;= STOP_LOSS_PRICE) <span class="keyword">or</span> \</span><br><span class="line">                (position_short <span class="keyword">and</span> bars[<span class="number">0</span>].close - context.open_position_price &gt;= STOP_LOSS_PRICE):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;达到止损点，全部平仓&#x27;</span>)</span><br><span class="line">            order_close_all()  <span class="comment"># 平仓</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 反转策略:</span></span><br><span class="line">        <span class="keyword">if</span> position_long:  <span class="comment"># 多仓条件下</span></span><br><span class="line">            <span class="keyword">if</span> data.high.iloc[<span class="number">1</span>] &gt; sSetup <span class="keyword">and</span> bars[<span class="number">0</span>].close &lt; sEnter:</span><br><span class="line">                <span class="comment"># 多头持仓,当日内最高价超过观察卖出价后，</span></span><br><span class="line">                <span class="comment"># 盘中价格出现回落，且进一步跌破反转卖出价构成的支撑线时，</span></span><br><span class="line">                <span class="comment"># 采取反转策略，即在该点位反手做空</span></span><br><span class="line">                order_close_all()  <span class="comment"># 平仓</span></span><br><span class="line">                order_volume(symbol=context.mainContract, volume=<span class="number">10</span>, side=OrderSide_Sell,</span><br><span class="line">                             order_type=OrderType_Market, position_effect=PositionEffect_Open)  <span class="comment"># 做空</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;多头持仓,当日内最高价超过观察卖出价后跌破反转卖出价: 反手做空&quot;</span>)</span><br><span class="line">                context.open_position_price = bars[<span class="number">0</span>].close</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> position_short:  <span class="comment"># 空头持仓</span></span><br><span class="line">            <span class="keyword">if</span> data.low.iloc[<span class="number">1</span>] &lt; bSetup <span class="keyword">and</span> bars[<span class="number">0</span>].close &gt; bEnter:</span><br><span class="line">                <span class="comment"># 空头持仓，当日内最低价低于观察买入价后，</span></span><br><span class="line">                <span class="comment"># 盘中价格出现反弹，且进一步超过反转买入价构成的阻力线时，</span></span><br><span class="line">                <span class="comment"># 采取反转策略，即在该点位反手做多</span></span><br><span class="line">                order_close_all()  <span class="comment"># 平仓</span></span><br><span class="line">                order_volume(symbol=context.mainContract, volume=<span class="number">10</span>, side=OrderSide_Buy,</span><br><span class="line">                             order_type=OrderType_Market, position_effect=PositionEffect_Open)  <span class="comment"># 做多</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;空头持仓,当日最低价低于观察买入价后超过反转买入价: 反手做多&quot;</span>)</span><br><span class="line">                context.open_position_price = bars[<span class="number">0</span>].close</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> context.now.hour == <span class="number">14</span> <span class="keyword">and</span> context.now.minute == <span class="number">59</span>:</span><br><span class="line">        order_close_all()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;全部平仓&#x27;</span>)</span><br><span class="line">        context.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">        filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">        mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">        token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">        backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">        backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">        backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">        backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">        backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">        backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2019-10-1 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-04-16 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_initial_cash=<span class="number">1000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="布林线均值回归-股票">布林线均值回归(股票)</h2>
<h3 id="原理-6">原理</h3>
<p>提起布林线均值回归策略，就不得不提布林带这个概念。布林带是利用统计学中的均值和标准差联合计算得出的，分为均线，上轨线和下轨线。布林线均值回归策略认为，标的价格在上轨线和下轨线围成的范围内浮动，即使短期内突破上下轨，但长期内仍然会回归到布林带之中。因此，一旦突破上下轨，即形成买卖信号。</p>
<p>当股价向上突破上界时，为卖出信号，当股价向下突破下界时，为买入信号。</p>
<p>BOLL 线的计算公式：</p>
<ul>
<li>中轨线 = N 日移动平均线</li>
<li>上轨线 = 中轨线 + k 标准差</li>
<li>下轨线 = 中轨线 - k 标准差</li>
</ul>
<div class="note info flat"><p>这里指的都是收盘价的平均值和标准差。</p>
</div>
<h3 id="策略思路">策略思路</h3>
<p>第一步：根据数据计算 BOLL 线的上下界</p>
<p>第二步：获得持仓信号</p>
<p>第三步：回测分析</p>
<h3 id="策略代码-5">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">本策略采用布林线进行均值回归交易。当价格触及布林线上轨的时候进行卖出，当触及下轨的时候，进行买入。</span></span><br><span class="line"><span class="string">使用600004在 2009-09-17 13:00:00 到 2020-03-21 15:00:00 进行了回测。</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">1：实盘中，如果在收盘的那一根bar或tick触发交易信号，需要自行处理，实盘可能不会成交。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 策略中必须有init方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 设置布林线的三个参数</span></span><br><span class="line">    context.maPeriod = <span class="number">26</span>  <span class="comment"># 计算BOLL布林线中轨的参数</span></span><br><span class="line">    context.stdPeriod = <span class="number">26</span>  <span class="comment"># 计算BOLL 标准差的参数</span></span><br><span class="line">    context.stdRange = <span class="number">1</span>  <span class="comment"># 计算BOLL 上下轨和中轨距离的参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置要进行回测的合约</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHSE.600004&#x27;</span>  <span class="comment"># 订阅&amp;交易标的, 此处订阅的是600004</span></span><br><span class="line">    context.period = <span class="built_in">max</span>(context.maPeriod, context.stdPeriod, context.stdRange) + <span class="number">1</span>  <span class="comment"># 订阅数据滑窗长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 订阅行情</span></span><br><span class="line">    subscribe(symbols= context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.period)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 获取数据滑窗，只要在init里面有订阅，在这里就可以取的到，返回值是pandas.DataFrame</span></span><br><span class="line">    data = context.data(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.period, fields=<span class="string">&#x27;close&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算boll的上下界</span></span><br><span class="line">    bollUpper = data[<span class="string">&#x27;close&#x27;</span>].rolling(context.maPeriod).mean() \</span><br><span class="line">                + context.stdRange * data[<span class="string">&#x27;close&#x27;</span>].rolling(context.stdPeriod).std()</span><br><span class="line">    bollBottom = data[<span class="string">&#x27;close&#x27;</span>].rolling(context.maPeriod).mean() \</span><br><span class="line">                 - context.stdRange * data[<span class="string">&#x27;close&#x27;</span>].rolling(context.stdPeriod).std()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取现有持仓</span></span><br><span class="line">    pos = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交易逻辑与下单</span></span><br><span class="line">    <span class="comment"># 当有持仓，且股价穿过BOLL上界的时候卖出股票。</span></span><br><span class="line">    <span class="keyword">if</span> data.close.values[-<span class="number">1</span>] &gt; bollUpper.values[-<span class="number">1</span>] <span class="keyword">and</span> data.close.values[-<span class="number">2</span>] &lt; bollUpper.values[-<span class="number">2</span>]:</span><br><span class="line">        <span class="keyword">if</span> pos:  <span class="comment"># 有持仓就市价卖出股票。</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">100</span>, side=OrderSide_Sell,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;以市价单卖出一手&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 当没有持仓，且股价穿过BOLL下界的时候买出股票。</span></span><br><span class="line">    <span class="keyword">elif</span> data.close.values[-<span class="number">1</span>] &lt; bollBottom.values[-<span class="number">1</span>] <span class="keyword">and</span> data.close.values[-<span class="number">2</span>] &gt; bollBottom.values[-<span class="number">2</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pos:  <span class="comment"># 没有持仓就买入一百股。</span></span><br><span class="line">            order_volume(symbol=context.symbol, volume=<span class="number">100</span>, side=OrderSide_Buy,</span><br><span class="line">                         order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;以市价单买入一手&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">        filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">        mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">        token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">        backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">        backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">        backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">        backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">        backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">        backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2009-09-17 13:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-03-21 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">1000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="alpha-对冲-股票-期货">alpha 对冲(股票+期货)</h2>
<h3 id="原理-7">原理</h3>
<h4 id="何为-alpha？">何为 alpha？</h4>
<p>提到 Alpha 策略，首先要理解什么是 CAPM 模型。</p>
<p>CAPM 模型于 1964 年被 Willian Sharpe 等人提出。Sharpe 等人认为，假设市场是均衡的，资产的预期超额收益率就由市场收益超额收益和风险暴露决定的。如下式所示。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">(</mo><msub><mi>r</mi><mi>p</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>r</mi><mi>f</mi></msub><mo>+</mo><msub><mi>β</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mi>m</mi></msub><mo>−</mo><msub><mi>r</mi><mi>f</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E(r_p) = r_f + \beta_p(r_m - r_f)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">r_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为市场组合，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">r_f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 为无风险收益率。</p>
<p>根据 CAPM 模型可知，投资组合的预期收益由两部分组成，一部分为无风险收益率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">r_f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>，另一部分为风险收益率。</p>
<p>CAPM 模型一经推出就受到了市场的追捧。但在应用过程中发现，CAPM 模型表示的是在均衡状态下市场的情况，但市场并不总是处于均衡状态，个股总会获得超出市场基准水平的收益，即在 CAPM 模型的右端总是存在一个 alpha 项。</p>
<p>为了解决这个问题，1968 年，美国经济学家迈克·詹森（Michael Jensen）提出了詹森指数来描述这个 alpha，因此又称 alpha 指数。计算方式如式 2 所示。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>α</mi><mi>p</mi></msub><mo>=</mo><msub><mi>r</mi><mi>p</mi></msub><mo>−</mo><mo stretchy="false">[</mo><msub><mi>r</mi><mi>f</mi></msub><mo>+</mo><msub><mi>β</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mi>m</mi></msub><mo>−</mo><msub><mi>r</mi><mi>f</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\alpha_p = r_p - [r_f + \beta_p(r_m - r_f)]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span></p>
<p>因此，投资组合的收益可以改写成</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mi>p</mi></msub><mo>=</mo><mi>α</mi><mo>+</mo><msub><mi>β</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mi>m</mi></msub><mo>−</mo><msub><mi>r</mi><mi>f</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r_p = \alpha + \beta_p(r_m - r_f)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>可将投资组合的收益拆分为 alpha 收益和 beta 收益。其中 beta 的计算公式为</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>β</mi><mo>=</mo><mfrac><mrow><mi>c</mi><mi>o</mi><mi>v</mi><mo stretchy="false">(</mo><msub><mi>r</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>r</mi><mi>m</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msub><mi>σ</mi><mi>p</mi></msub><msub><mi>σ</mi><mi>m</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\beta = \frac{cov(r_p, r_m)}{\sigma_p \sigma_m}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3991em;vertical-align:-0.9721em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>β 是由市场决定的，属于系统性风险，与投资者管理能力无关，只与投资组合与市场的关系有关。当市场整体下跌时，β 对应的收益也会随着下跌（假设 beta 为正）。alpha 收益与市场无关，是投资者自身能力的体现。投资者通过自身的经验进行选股择时，得到超过市场的收益。</p>
<h4 id="什么是-alpha-对冲策略？">什么是 alpha 对冲策略？</h4>
<p>所谓的 alpha 对冲不是将 alpha 收益对冲掉，恰恰相反，alpha 对冲策略是将 β 收益对冲掉，只获取 alpha 收益</p>
<p>alpha 对冲策略将市场性风险对冲掉，只剩下 alpha 收益，整体收益完全取决于投资者自身的能力水平，与市场无关。</p>
<h4 id="怎么对冲？">怎么对冲？</h4>
<p>alpha 对冲策略常采用股指期货（指<strong>以股票价格指数</strong>作为标的物的金融期货合约）做对冲。在股票市场上做多头，在期货市场上做股指期货空头。当股票现货市场亏损时，可以通过期货市场弥补亏损；当期货市场亏损时，可以通过股票现货市场弥补亏损。</p>
<h4 id="策略要点">策略要点</h4>
<p>alpha 策略能否成功，主要包括以下几个要点：</p>
<ol>
<li>获取到的 alpha 收益是否足够高，能否超过无风险利率以及指数.</li>
<li>期货和现货之间的基差变化.</li>
<li>期货合约的选择.</li>
</ol>
<p>alpha 对冲只是一种对冲市场风险的方法，在创建策略时需要结合其他理论一起使用，怎样获取到较高的 alpha 收益才是决定策略整体收益的关键。</p>
<h3 id="策略实现">策略实现</h3>
<p>第一步：制定一个选股策略，构建投资组合，使其同时拥有 alpha 和 beta 收益。</p>
<p>（本策略选取过去一天 EV/EBITDA 值并选取 30 只 EV/EBITDA 值最小且大于零的股票）</p>
<p>第二步：做空股指期货，将投资组合的 beta 抵消，只剩 alpha 部分。</p>
<p>第三步：进行回测。</p>
<div class="note info flat"><p>企业价值倍数 = EV/EBITDA</p>
<p>EV 为公司价值，EBITDA 为息税折旧摊销前利润</p>
</div>
<h3 id="策略代码-6">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略每隔1个月定时触发计算SHSE.000300成份股的过去一天EV/EBITDA值并选取30只EV/EBITDA值最小且大于零的股票</span></span><br><span class="line"><span class="string">对不在股票池的股票平仓并等权配置股票池的标的</span></span><br><span class="line"><span class="string">并用相应的CFFEX.IF对应的真实合约等额对冲</span></span><br><span class="line"><span class="string">回测数据为:SHSE.000300和他们的成份股和CFFEX.IF对应的真实合约</span></span><br><span class="line"><span class="string">回测时间为:2017-07-01 08:00:00到2017-10-01 16:00:00</span></span><br><span class="line"><span class="string">注意：本策略仅供参考，实际使用中要考虑到期货和股票处于两个不同的账户，需要人为的保证两个账户的资金相同。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 每月第一个交易日09:40:00的定时执行algo任务（仿真和实盘时不支持该频率）</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1m&#x27;</span>, time_rule=<span class="string">&#x27;09:40:00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置开仓在股票和期货的资金百分比(期货在后面自动进行杠杆相关的调整)</span></span><br><span class="line">    context.percentage_stock = <span class="number">0.4</span></span><br><span class="line">    context.percentage_futures = <span class="number">0.4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 获取当前时刻</span></span><br><span class="line">    now = context.now</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取上一个交易日</span></span><br><span class="line">    last_day = get_previous_trading_date(exchange=<span class="string">&#x27;SHSE&#x27;</span>, date=now)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取沪深300成份股的股票代码</span></span><br><span class="line">    stock300 = get_history_constituents(index=<span class="string">&#x27;SHSE.000300&#x27;</span>, start_date=last_day,</span><br><span class="line">                                                end_date=last_day)[<span class="number">0</span>][<span class="string">&#x27;constituents&#x27;</span>].keys()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取上一个工作日的CFFEX.IF对应的合约</span></span><br><span class="line">    index_futures = get_continuous_contracts(csymbol=<span class="string">&#x27;CFFEX.IF&#x27;</span>, start_date=last_day, end_date=last_day)[-<span class="number">1</span>][<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当天有交易的股票</span></span><br><span class="line">    not_suspended_info = get_history_instruments(symbols=stock300, start_date=now, end_date=now)</span><br><span class="line">    not_suspended_symbols = [item[<span class="string">&#x27;symbol&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> not_suspended_info <span class="keyword">if</span> <span class="keyword">not</span> item[<span class="string">&#x27;is_suspended&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取成份股EV/EBITDA大于0并为最小的30个</span></span><br><span class="line">    fin = get_fundamentals(table=<span class="string">&#x27;trading_derivative_indicator&#x27;</span>, symbols=not_suspended_symbols,</span><br><span class="line">                           start_date=now, end_date=now, fields=<span class="string">&#x27;EVEBITDA&#x27;</span>,</span><br><span class="line">                           <span class="built_in">filter</span>=<span class="string">&#x27;EVEBITDA&gt;0&#x27;</span>, order_by=<span class="string">&#x27;EVEBITDA&#x27;</span>, limit=<span class="number">30</span>, df=<span class="literal">True</span>)</span><br><span class="line">    fin.index = fin.symbol</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当前仓位</span></span><br><span class="line">    positions = context.account().positions()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 平不在标的池或不为当前股指期货主力合约对应真实合约的标的</span></span><br><span class="line">    <span class="keyword">for</span> position <span class="keyword">in</span> positions:</span><br><span class="line">        symbol = position[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        sec_type = get_instrumentinfos(symbols=symbol)[<span class="number">0</span>][<span class="string">&#x27;sec_type&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 若类型为期货且不在标的池则平仓</span></span><br><span class="line">        <span class="keyword">if</span> sec_type == SEC_TYPE_FUTURE <span class="keyword">and</span> symbol != index_futures:</span><br><span class="line">            order_target_percent(symbol=symbol, percent=<span class="number">0</span>, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Short)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平不在标的池的&#x27;</span>, symbol)</span><br><span class="line">        <span class="keyword">elif</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> fin.index:</span><br><span class="line">            order_target_percent(symbol=symbol, percent=<span class="number">0</span>, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Long)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平不在标的池的&#x27;</span>, symbol)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取股票的权重</span></span><br><span class="line">    percent = context.percentage_stock / <span class="built_in">len</span>(fin.index)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买在标的池中的股票</span></span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> fin.index:</span><br><span class="line">        order_target_percent(symbol=symbol, percent=percent, order_type=OrderType_Market,</span><br><span class="line">                             position_side=PositionSide_Long)</span><br><span class="line">        <span class="built_in">print</span>(symbol, <span class="string">&#x27;以市价单调多仓到仓位&#x27;</span>, percent)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取股指期货的保证金比率</span></span><br><span class="line">    ratio = get_history_instruments(symbols=index_futures, start_date=last_day, end_date=last_day)[<span class="number">0</span>][<span class="string">&#x27;margin_ratio&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新股指期货的权重</span></span><br><span class="line">    percent = context.percentage_futures * ratio</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买入股指期货对冲</span></span><br><span class="line">    <span class="comment"># 注意：股指期货的percent参数是按照期货的保证金来算比例，不是按照合约价值， 比如说0.1就是用0.1的仓位的资金全部买入期货。</span></span><br><span class="line">    order_target_percent(symbol=index_futures, percent=percent, order_type=OrderType_Market,</span><br><span class="line">                         position_side=PositionSide_Short)</span><br><span class="line">    <span class="built_in">print</span>(index_futures, <span class="string">&#x27;以市价单调空仓到仓位&#x27;</span>, percent)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2017-07-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">10000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="网格交易-期货">网格交易(期货)</h2>
<h3 id="原理-8">原理</h3>
<h4 id="什么是网格交易法？">什么是网格交易法？</h4>
<p>网格交易法是一种利用行情震荡进行获利的策略。在标的价格不断震荡的过程中，对标的价格绘制网格，在市场价格触碰到某个网格线时进行加减仓操作尽可能获利。</p>
<p>网格交易法属于左侧交易的一种。与右侧交易不同，网格交易法并非跟随行情，追涨杀跌，而是逆势而为，在价格下跌时买入，价格上涨时卖出。</p>
<h4 id="怎样设计网格？">怎样设计网格？</h4>
<p>投资者可以随意设置网格的宽度和数量。既可以设置为等宽度，也可以设置为不等宽度的。设置等宽度网格可能会导致买点卖点过早，收益率较低。设置不等宽度网格能够避免这个问题，但如果行情出现不利变动，可能会错失买卖机会。</p>
<h4 id="核心">核心</h4>
<p>网格交易主要包括以下几个核心要点：</p>
<ul>
<li>
<p>挑选的标的最好是价格变化较大，交易较为活跃</p>
<p>网格交易是基于行情震荡进行获利的策略，如果标的不活跃，价格波动不大，很难触发交易。</p>
</li>
<li>
<p>选出网格的压力位和阻力位</p>
<p>确定适当的压力位和阻力位，使价格大部分时间能够在压力位和阻力位之间波动。如果压力位和阻力位设置范围过大，会导致难以触发交易；如果压力位和阻力位设置范围过小，则会频繁触发交易。</p>
</li>
<li>
<p>设置网格的宽度和数量</p>
<p>设定多少个网格以及网格的宽度可根据投资者自身喜好自行确定。</p>
</li>
</ul>
<h3 id="策略思路-2">策略思路</h3>
<p>第一步：确定价格中枢、压力位和阻力位</p>
<p>第二步：确定网格的数量和间隔</p>
<p>第三步：当价格触碰到网格线时，若高于买入价，则每上升一格卖出 m 手；若低于买入价，则每下跌一格买入 m 手。</p>
<h3 id="策略代码-7">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略标的为：SHFE.rb1901</span></span><br><span class="line"><span class="string">价格中枢设定为：前一交易日的收盘价</span></span><br><span class="line"><span class="string">从阻力位到压力位分别为：1.03 * open、1.02 * open、1.01 * open、open、0.99 * open、0.98 * open、0.97 * open</span></span><br><span class="line"><span class="string">每变动一个网格，交易量变化100个单位</span></span><br><span class="line"><span class="string">回测数据为:SHFE.rb1901的1min数据</span></span><br><span class="line"><span class="string">回测时间为:2017-07-01 08:00:00到2017-10-01 16:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 策略标的为SHFE.rb1901</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHFE.rb1901&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 订阅SHFE.rb1901, bar频率为1min</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;60s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置每变动一格，增减的数量</span></span><br><span class="line">    context.volume = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 储存前一个网格所处区间，用来和最新网格所处区间作比较</span></span><br><span class="line">    context.last_grid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 以前一日的收盘价为中枢价格</span></span><br><span class="line">    context.center = history_n(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, end_time=context.now, count=<span class="number">1</span>, fields=<span class="string">&#x27;close&#x27;</span>)[<span class="number">0</span>][<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 记录上一次交易时网格范围的变化情况（例如从4区到5区，记为4,5）</span></span><br><span class="line">    context.grid_change_last = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    bar = bars[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取多仓仓位</span></span><br><span class="line">    position_long = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取空仓仓位</span></span><br><span class="line">    position_short = context.account().position(symbol=context.symbol, side=PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置网格和当前价格所处的网格区域</span></span><br><span class="line">    context.band = np.array([<span class="number">0.97</span>, <span class="number">0.98</span>, <span class="number">0.99</span>, <span class="number">1</span>, <span class="number">1.01</span>, <span class="number">1.02</span>, <span class="number">1.03</span>]) * context.center</span><br><span class="line">    grid = pd.cut([bar.close], context.band, labels=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果价格超出网格设置范围，则提示调节网格宽度和数量</span></span><br><span class="line">    <span class="keyword">if</span> np.isnan(grid):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;价格波动超过网格范围，可适当调节网格宽度和数量&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果新的价格所处网格区间和前一个价格所处的网格区间不同，说明触碰到了网格线，需要进行交易</span></span><br><span class="line">    <span class="comment"># 如果新网格大于前一天的网格，做空或平多</span></span><br><span class="line">    <span class="keyword">if</span> context.last_grid &lt; grid:</span><br><span class="line">        <span class="comment"># 记录新旧格子范围（按照大小排序）</span></span><br><span class="line">        grid_change_new = [context.last_grid,grid]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 几种例外：</span></span><br><span class="line">        <span class="comment"># 当last_grid = 0 时是初始阶段，不构成信号</span></span><br><span class="line">        <span class="comment"># 如果此时grid = 3，说明当前价格仅在开盘价之下的3区域中，没有突破网格线</span></span><br><span class="line">        <span class="comment"># 如果此时grid = 4，说明当前价格仅在开盘价之上的4区域中，没有突破网格线</span></span><br><span class="line">        <span class="keyword">if</span> context.last_grid == <span class="number">0</span>:</span><br><span class="line">            context.last_grid = grid</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> context.last_grid != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 如果前一次开仓是4-5，这一次是5-4，算是没有突破，不成交</span></span><br><span class="line">            <span class="keyword">if</span> grid_change_new != context.grid_change_last:</span><br><span class="line">                <span class="comment"># 更新前一次的数据</span></span><br><span class="line">                context.last_grid = grid</span><br><span class="line">                context.grid_change_last = grid_change_new</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 如果有多仓，平多</span></span><br><span class="line">                <span class="keyword">if</span> position_long:</span><br><span class="line">                    order_volume(symbol=context.symbol, volume=context.volume, side=OrderSide_Sell, order_type=OrderType_Market,</span><br><span class="line">                                 position_effect=PositionEffect_Close)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;以市价单平多仓&#123;&#125;手&#x27;</span>.<span class="built_in">format</span>(context.volume))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 否则，做空</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> position_long:</span><br><span class="line">                    order_volume(symbol=context.symbol, volume=context.volume, side=OrderSide_Sell, order_type=OrderType_Market,</span><br><span class="line">                                 position_effect=PositionEffect_Open)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;以市价单开空&#123;&#125;手&#x27;</span>.<span class="built_in">format</span>(context.volume))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果新网格小于前一天的网格，做多或平空</span></span><br><span class="line">    <span class="keyword">if</span> context.last_grid &gt; grid:</span><br><span class="line">        <span class="comment"># 记录新旧格子范围（按照大小排序）</span></span><br><span class="line">        grid_change_new = [grid, context.last_grid]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 几种例外：</span></span><br><span class="line">        <span class="comment"># 当last_grid = 0 时是初始阶段，不构成信号</span></span><br><span class="line">        <span class="comment"># 如果此时grid = 3，说明当前价格仅在开盘价之下的3区域中，没有突破网格线</span></span><br><span class="line">        <span class="comment"># 如果此时grid = 4，说明当前价格仅在开盘价之上的4区域中，没有突破网格线</span></span><br><span class="line">        <span class="keyword">if</span> context.last_grid == <span class="number">0</span>:</span><br><span class="line">            context.last_grid = grid</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> context.last_grid != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 如果前一次开仓是4-5，这一次是5-4，算是没有突破，不成交</span></span><br><span class="line">            <span class="keyword">if</span> grid_change_new != context.grid_change_last:</span><br><span class="line">                <span class="comment"># 更新前一次的数据</span></span><br><span class="line">                context.last_grid = grid</span><br><span class="line">                context.grid_change_last = grid_change_new</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 如果有空仓，平空</span></span><br><span class="line">                <span class="keyword">if</span> position_short:</span><br><span class="line">                    order_volume(symbol=context.symbol, volume=context.volume, side=OrderSide_Buy,</span><br><span class="line">                                 order_type=OrderType_Market,</span><br><span class="line">                                 position_effect=PositionEffect_Close)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;以市价单平空仓&#123;&#125;手&#x27;</span>.<span class="built_in">format</span>(context.volume))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 否则，做多</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> position_short:</span><br><span class="line">                    order_volume(symbol=context.symbol, volume=context.volume, side=OrderSide_Buy,</span><br><span class="line">                                 order_type=OrderType_Market,</span><br><span class="line">                                 position_effect=PositionEffect_Open)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;以市价单开多&#123;&#125;手&#x27;</span>.<span class="built_in">format</span>(context.volume))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设计一个止损条件：当持仓量达到10手，全部平仓</span></span><br><span class="line">    <span class="keyword">if</span> position_short == <span class="number">10</span> <span class="keyword">or</span> position_long == <span class="number">10</span>:</span><br><span class="line">        order_close_all()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;触发止损，全部平仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2018-07-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2018-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">100000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="多因子选股-股票">多因子选股(股票)</h2>
<h3 id="原理-9">原理</h3>
<p>多因子策略是最广泛应用的策略之一。CAPM 模型的提出为股票的收益提供了解释，但随着各种市场异象的出现，使得人们发现股票存在超额收益，这种收益不能为市场因子所解释，因此，出现了多因子模型。</p>
<p>多因子模型最早是由 Fama-French 提出，包括三因子和五因子模型。Fama 认为，股票的超额收益可以由市场因子、市值因子和账面价值比因子共同解释。随着市场的发展，出现许多三因子模型难以解释的现象。因此，Fama 又提出了五因子模型，加入了盈利水平、投资水平因子。</p>
<p>此后，陆续出现了六因子模型、八因子模型等，目前多少个因子是合适的尚无定论。</p>
<h4 id="Fama-French-三因子模型">Fama-French 三因子模型</h4>
<p>Fama 等人在 CAPM 的基础上，Fama 加入了 HML 和 SMB 两个因子，提出了三因子模型，也是多因子模型的基础。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>−</mo><msub><mi>R</mi><mi>f</mi></msub><mo>=</mo><msub><mi>β</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>M</mi><mi>K</mi><mi>T</mi></mrow></msub><mo stretchy="false">(</mo><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mi>M</mi></msub><mo stretchy="false">]</mo><mo>−</mo><msub><mi>R</mi><mi>f</mi></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>β</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>S</mi><mi>M</mi><mi>B</mi></mrow></msub><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mrow><mi>S</mi><mi>M</mi><mi>B</mi></mrow></msub><mo stretchy="false">]</mo><mo>+</mo><msub><mi>β</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>H</mi><mi>M</mi><mi>L</mi></mrow></msub><mo stretchy="false">[</mo><msub><mi>R</mi><mrow><mi>H</mi><mi>M</mi><mi>L</mi></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[R_i] - R_f = \beta_{i,MKT}(E[R_M] - R_f) + \beta_{i,SMB}E[R_{SMB}] + \beta_{i,HML}[R_{HML}]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">SMB</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">SMB</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mi>i</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[R_i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 代表股票 i 的预期收益率，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>f</mi></msub></mrow><annotation encoding="application/x-tex">R_f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 代表无风险收益率，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mi>M</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[R_M]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 为市场组合预期收益率，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mrow><mi>S</mi><mi>M</mi><mi>B</mi></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[R_{SMB}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">SMB</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mrow><mi>H</mi><mi>M</mi><mi>L</mi></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[R_{HML}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 分别为规模因子收益率和价值因子预期收益率</p>
<p>为构建价值因子和规模因子，Fama 选择 BM(账面市值比) 和市值两个指标进行双重排序，将股票分为大市值组 B 和小市值组 S；按照账面市值比将股票分为 BM 高于 70%分位数的 H 组，BM 低于 30%分位数的 L 组，BM 处于二者之间的记为 M 组。如表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th>H</th>
<th>M</th>
<th>L</th>
</tr>
</thead>
<tbody>
<tr>
<td>市值分组</td>
<td>S</td>
<td>S/H</td>
<td>S/M</td>
<td>S/L</td>
</tr>
<tr>
<td>市值分组</td>
<td>B</td>
<td>B/H</td>
<td>B/M</td>
<td>B/L</td>
</tr>
</tbody>
</table>
<p>得到上述分组以后，就可以构建规模和价值两个因子。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>M</mi><mi>B</mi><mo>=</mo><mfrac><mn>1</mn><mn>3</mn></mfrac><mo stretchy="false">(</mo><mi>S</mi><mi mathvariant="normal">/</mi><mi>H</mi><mo>+</mo><mi>S</mi><mi mathvariant="normal">/</mi><mi>M</mi><mo>+</mo><mi>S</mi><mi mathvariant="normal">/</mi><mi>L</mi><mo stretchy="false">)</mo><mo>−</mo><mfrac><mn>1</mn><mn>3</mn></mfrac><mo stretchy="false">(</mo><mi>B</mi><mi mathvariant="normal">/</mi><mi>H</mi><mo>+</mo><mi>B</mi><mi mathvariant="normal">/</mi><mi>M</mi><mo>+</mo><mi>B</mi><mi mathvariant="normal">/</mi><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SMB = \frac{1}{3}(S/H + S/M + S/L) - \frac{1}{3}(B/H + B/M + B/L)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">SMB</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord mathnormal">L</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">/</span><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mi>M</mi><mi>L</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi>S</mi><mi mathvariant="normal">/</mi><mi>H</mi><mo>+</mo><mi>B</mi><mi mathvariant="normal">/</mi><mi>H</mi><mo stretchy="false">)</mo><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi>S</mi><mi mathvariant="normal">/</mi><mi>L</mi><mo>+</mo><mi>B</mi><mi mathvariant="normal">/</mi><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">HML = \frac{1}{2}(S/H + B/H) - \frac{1}{2}(S/L + B/L)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord">/</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">/</span><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span></span></p>
<p>上述式子解释一下可以发现，规模因子是三个小市值组合的等权平均减去三个大市值组合的等权平均；价值因子是两个高 BM 组合的等权平均减去两个低 BM 组合的等权平均。</p>
<h4 id="策略设计思路">策略设计思路</h4>
<p>在用三因子模型估算股票预期收益率时，经常会发现并非每只股票都能严格吻合式 1，大部分股票都会存在一个 alpha 截距项。当存在 alpha 截距项时，说明股票当前价格偏离均衡价格。基于此，可以设计套利策略。</p>
<ul>
<li>alpha &lt; 0 时，说明股票收益率低于均衡水平，股票价格被低估，应该买入。</li>
<li>alpha &gt; 0 时，说明股票收益率高于均衡水平，股票价格被高估，应该卖出。</li>
</ul>
<p>因此，可以获取 alpha 最小并且小于 0 的 10 只的股票买入开仓。</p>
<h3 id="策略步骤">策略步骤</h3>
<p>第一步：获取股票市值以及账面市值比数据。</p>
<p>第二步：将股票按照各个因子进行排序分组，分组方法如上表所示。</p>
<p>第三步：依据式 2 式 3，计算 SMB、HML 因子。</p>
<p>第四步：因子回归，计算 alpha 值。获取 alpha 最小并且小于 0 的 10 只的股票买入开仓。</p>
<h3 id="策略代码-8">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略每隔1个月定时触发,根据Fama-French三因子模型对每只股票进行回归，得到其alpha值。</span></span><br><span class="line"><span class="string">假设Fama-French三因子模型可以完全解释市场，则alpha为负表明市场低估该股，因此应该买入。</span></span><br><span class="line"><span class="string">策略思路：</span></span><br><span class="line"><span class="string">计算市场收益率、个股的账面市值比和市值,并对后两个进行了分类,</span></span><br><span class="line"><span class="string">根据分类得到的组合分别计算其市值加权收益率、SMB和HML.</span></span><br><span class="line"><span class="string">对各个股票进行回归(假设无风险收益率等于0)得到alpha值.</span></span><br><span class="line"><span class="string">选取alpha值小于0并为最小的10只股票进入标的池</span></span><br><span class="line"><span class="string">平掉不在标的池的股票并等权买入在标的池的股票</span></span><br><span class="line"><span class="string">回测数据:SHSE.000300的成份股</span></span><br><span class="line"><span class="string">回测时间:2017-07-01 08:00:00到2017-10-01 16:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 每月第一个交易日的09:40 定时执行algo任务（仿真和实盘时不支持该频率）</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1m&#x27;</span>, time_rule=<span class="string">&#x27;09:40:00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据滑窗</span></span><br><span class="line">    context.date = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置开仓的最大资金量</span></span><br><span class="line">    context.ratio = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 账面市值比的大/中/小分类</span></span><br><span class="line">    context.BM_BIG = <span class="number">3.0</span></span><br><span class="line">    context.BM_MID = <span class="number">2.0</span></span><br><span class="line">    context.BM_SMA = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 市值大/小分类</span></span><br><span class="line">    context.MV_BIG = <span class="number">2.0</span></span><br><span class="line">    context.MV_SMA = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算市值加权的收益率的函数,MV为市值的分类对应的组别,BM为账目市值比的分类对应的组别</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">market_value_weighted</span>(<span class="params">stocks, MV, BM</span>):</span><br><span class="line">    select = stocks[(stocks[<span class="string">&#x27;NEGOTIABLEMV&#x27;</span>] == MV) &amp; (stocks[<span class="string">&#x27;BM&#x27;</span>] == BM)] <span class="comment"># 选出市值为MV，账目市值比为BM的所有股票数据</span></span><br><span class="line">    market_value = select[<span class="string">&#x27;mv&#x27;</span>].values     <span class="comment"># 对应组的全部市值数据</span></span><br><span class="line">    mv_total = np.<span class="built_in">sum</span>(market_value)        <span class="comment"># 市值求和</span></span><br><span class="line">    mv_weighted = [mv / mv_total <span class="keyword">for</span> mv <span class="keyword">in</span> market_value]   <span class="comment"># 市值加权的权重</span></span><br><span class="line">    stock_return = select[<span class="string">&#x27;return&#x27;</span>].values</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回市值加权的收益率的和</span></span><br><span class="line">    return_total = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(mv_weighted)):</span><br><span class="line">        return_total.append(mv_weighted[i] * stock_return[i])</span><br><span class="line">    return_total = np.<span class="built_in">sum</span>(return_total)</span><br><span class="line">    <span class="keyword">return</span> return_total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 获取上一个交易日的日期</span></span><br><span class="line">    last_day = get_previous_trading_date(exchange=<span class="string">&#x27;SHSE&#x27;</span>, date=context.now)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取沪深300成份股</span></span><br><span class="line">    context.stock300 = get_history_constituents(index=<span class="string">&#x27;SHSE.000300&#x27;</span>, start_date=last_day,</span><br><span class="line">                                                end_date=last_day)[<span class="number">0</span>][<span class="string">&#x27;constituents&#x27;</span>].keys()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当天有交易的股票</span></span><br><span class="line">    not_suspended = get_history_instruments(symbols=context.stock300, start_date=last_day, end_date=last_day)</span><br><span class="line">    not_suspended = [item[<span class="string">&#x27;symbol&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> not_suspended</span><br><span class="line">                     <span class="keyword">if</span> <span class="keyword">not</span> item[<span class="string">&#x27;is_suspended&#x27;</span>] <span class="keyword">and</span> item[<span class="string">&#x27;symbol&#x27;</span>]!= <span class="string">&#x27;SHSE.601313&#x27;</span>]  <span class="comment"># 601313 为退市股票</span></span><br><span class="line">    fin = get_fundamentals(table=<span class="string">&#x27;trading_derivative_indicator&#x27;</span>, symbols=not_suspended,</span><br><span class="line">                           start_date=last_day, end_date=last_day,fields=<span class="string">&#x27;PB,NEGOTIABLEMV&#x27;</span>, df=<span class="literal">True</span>)  <span class="comment"># 获取P/B和市值数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算账面市值比,为P/B的倒数</span></span><br><span class="line">    fin[<span class="string">&#x27;PB&#x27;</span>] = (fin[<span class="string">&#x27;PB&#x27;</span>] ** -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算市值的50%的分位点,用于后面的分类</span></span><br><span class="line">    size_gate = fin[<span class="string">&#x27;NEGOTIABLEMV&#x27;</span>].quantile(<span class="number">0.50</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算账面市值比的30%和70%分位点,用于后面的分类</span></span><br><span class="line">    bm_gate = [fin[<span class="string">&#x27;PB&#x27;</span>].quantile(<span class="number">0.30</span>), fin[<span class="string">&#x27;PB&#x27;</span>].quantile(<span class="number">0.70</span>)]</span><br><span class="line">    fin.index = fin.symbol</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置存放股票收益率的list</span></span><br><span class="line">    x_return = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对未停牌的股票进行处理</span></span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> not_suspended:</span><br><span class="line">        <span class="comment"># 计算收益率，存放到x_return里面</span></span><br><span class="line">        close = history_n(symbol=symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.date + <span class="number">1</span>, end_time=last_day, fields=<span class="string">&#x27;close&#x27;</span>,</span><br><span class="line">                          skip_suspended=<span class="literal">True</span>, fill_missing=<span class="string">&#x27;Last&#x27;</span>, adjust=ADJUST_PREV, df=<span class="literal">True</span>)[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">        stock_return = close[-<span class="number">1</span>] / close[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line">        pb = fin[<span class="string">&#x27;PB&#x27;</span>][symbol]</span><br><span class="line">        market_value = fin[<span class="string">&#x27;NEGOTIABLEMV&#x27;</span>][symbol]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取[股票代码， 股票收益率, 账面市值比的分类, 市值的分类, 流通市值]</span></span><br><span class="line">        <span class="comment"># 其中账面市值比的分类为：大（3）、中（2）、小（1）</span></span><br><span class="line">        <span class="comment"># 流通市值的分类：大（2）、小（1）</span></span><br><span class="line">        <span class="keyword">if</span> pb &lt; bm_gate[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">if</span> market_value &lt; size_gate:</span><br><span class="line">                label = [symbol, stock_return, context.BM_SMA, context.MV_SMA, market_value]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                label = [symbol, stock_return, context.BM_SMA, context.MV_BIG, market_value]</span><br><span class="line">        <span class="keyword">elif</span> pb &lt; bm_gate[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">if</span> market_value &lt; size_gate:</span><br><span class="line">                label = [symbol, stock_return, context.BM_MID, context.MV_SMA, market_value]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                label = [symbol, stock_return, context.BM_MID, context.MV_BIG, market_value]</span><br><span class="line">        <span class="keyword">elif</span> market_value &lt; size_gate:</span><br><span class="line">            label = [symbol, stock_return, context.BM_BIG, context.MV_SMA, market_value]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            label = [symbol, stock_return, context.BM_BIG, context.MV_BIG, market_value]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(x_return) == <span class="number">0</span>:</span><br><span class="line">            x_return = label</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x_return = np.vstack([x_return, label])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将股票代码、 股票收益率、 账面市值比的分类、 市值的分类、 流通市值存为数据表</span></span><br><span class="line">    stocks = DataFrame(data=x_return, columns=[<span class="string">&#x27;symbol&#x27;</span>, <span class="string">&#x27;return&#x27;</span>, <span class="string">&#x27;BM&#x27;</span>, <span class="string">&#x27;NEGOTIABLEMV&#x27;</span>, <span class="string">&#x27;mv&#x27;</span>])</span><br><span class="line">    stocks.index = stocks.symbol</span><br><span class="line">    columns = [<span class="string">&#x27;return&#x27;</span>, <span class="string">&#x27;BM&#x27;</span>, <span class="string">&#x27;NEGOTIABLEMV&#x27;</span>, <span class="string">&#x27;mv&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> column <span class="keyword">in</span> columns:</span><br><span class="line">        stocks[column] = stocks[column].astype(np.float64)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算SMB.HML和市场收益率（市值加权法）</span></span><br><span class="line">    smb_s = (market_value_weighted(stocks, context.MV_SMA, context.BM_SMA) +</span><br><span class="line">             market_value_weighted(stocks, context.MV_SMA, context.BM_MID) +</span><br><span class="line">             market_value_weighted(stocks, context.MV_SMA, context.BM_BIG)) / <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取大市值组合的市值加权组合收益率</span></span><br><span class="line">    smb_b = (market_value_weighted(stocks, context.MV_BIG, context.BM_SMA) +</span><br><span class="line">             market_value_weighted(stocks, context.MV_BIG, context.BM_MID) +</span><br><span class="line">             market_value_weighted(stocks, context.MV_BIG, context.BM_BIG)) / <span class="number">3</span></span><br><span class="line">    smb = smb_s - smb_b</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取大账面市值比组合的市值加权组合收益率</span></span><br><span class="line">    hml_b = (market_value_weighted(stocks, context.MV_SMA, <span class="number">3</span>) +</span><br><span class="line">             market_value_weighted(stocks, context.MV_BIG, context.BM_BIG)) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取小账面市值比组合的市值加权组合收益率</span></span><br><span class="line">    hml_s = (market_value_weighted(stocks, context.MV_SMA, context.BM_SMA) +</span><br><span class="line">             market_value_weighted(stocks, context.MV_BIG, context.BM_SMA)) / <span class="number">2</span></span><br><span class="line">    hml = hml_b - hml_s</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取市场收益率</span></span><br><span class="line">    close = history_n(symbol=<span class="string">&#x27;SHSE.000300&#x27;</span>, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.date + <span class="number">1</span>,</span><br><span class="line">                      end_time=last_day, fields=<span class="string">&#x27;close&#x27;</span>, skip_suspended=<span class="literal">True</span>,</span><br><span class="line">                      fill_missing=<span class="string">&#x27;Last&#x27;</span>, adjust=ADJUST_PREV, df=<span class="literal">True</span>)[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">    market_return = close[-<span class="number">1</span>] / close[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line">    coff_pool = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对每只股票进行回归获取其alpha值</span></span><br><span class="line">    <span class="keyword">for</span> stock <span class="keyword">in</span> stocks.index:</span><br><span class="line">        x_value = np.array([[market_return], [smb], [hml], [<span class="number">1.0</span>]])</span><br><span class="line">        y_value = np.array([stocks[<span class="string">&#x27;return&#x27;</span>][stock]])</span><br><span class="line">        <span class="comment"># OLS估计系数</span></span><br><span class="line">        coff = np.linalg.lstsq(x_value.T, y_value)[<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line">        coff_pool.append(coff)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取alpha最小并且小于0的10只的股票进行操作(若少于10只则全部买入)</span></span><br><span class="line">    stocks[<span class="string">&#x27;alpha&#x27;</span>] = coff_pool</span><br><span class="line">    stocks = stocks[stocks.alpha &lt; <span class="number">0</span>].sort_values(by=<span class="string">&#x27;alpha&#x27;</span>).head(<span class="number">10</span>)</span><br><span class="line">    symbols_pool = stocks.index.tolist()</span><br><span class="line">    positions = context.account().positions()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 平不在标的池的股票</span></span><br><span class="line">    <span class="keyword">for</span> position <span class="keyword">in</span> positions:</span><br><span class="line">        symbol = position[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> symbols_pool:</span><br><span class="line">            order_target_percent(symbol=symbol, percent=<span class="number">0</span>, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Long)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平不在标的池的&#x27;</span>, symbol)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取股票的权重</span></span><br><span class="line">    percent = context.ratio / <span class="built_in">len</span>(symbols_pool)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 买在标的池中的股票</span></span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> symbols_pool:</span><br><span class="line">        order_target_percent(symbol=symbol, percent=percent, order_type=OrderType_Market,</span><br><span class="line">                             position_side=PositionSide_Long)</span><br><span class="line">        <span class="built_in">print</span>(symbol, <span class="string">&#x27;以市价单调多仓到仓位&#x27;</span>, percent)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2017-07-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">10000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="指数增强-股票">指数增强(股票)</h2>
<h3 id="原理-10">原理</h3>
<p>说到指数增强，就不得不说指数。</p>
<p>在进行股票投资时，有一种分类方式是将投资分为<strong>主动型投资</strong>和<strong>被动型投资</strong>。被动型投资是指完全复制指数，跟随指数的投资方式。与被动型投资相反，主动型投资是根据投资者的知识结合经验进行主动选股，不是被动跟随指数。主动型投资者期望获得超越市场的收益，被动型投资者满足于市场平均收益率水平。</p>
<p>指数增强是指在跟踪指数的基础上，采用一些判断基准，将不看好的股票权重调低或平仓，将看好的股票加大仓位，以提高收益率的方法。</p>
<p>既然如此，我已经判断出来哪只是“好股票”，哪只是“一般”的股票，为什么不直接买入？而是要买入指数呢？</p>
<p>指数增强不同于其他主动投资方式，除了注重获取超越市场的收益，还要兼顾降低组合风险，注重收益的稳定性。如果判断失误，只买入选中股票而非指数会导致投资者承受巨大亏损。</p>
<p>和 alpha 对冲策略类似，指数增强仅仅是一个思路，怎样选择“好股”还需投资者结合自身经验判断。</p>
<p>本策略利用“动量”这一概念，认为过去 5 天连续上涨的股票具备继续上涨的潜力，属于强势股；过去 5 天连续下跌的股票未来会继续下跌，属于弱势股。</p>
<h3 id="策略步骤-2">策略步骤</h3>
<p>第一步：选择跟踪指数，以权重大于 0.35%的成分股为股票池。</p>
<p>第二步：根据个股价格动量来判断是否属于优质股，即连续上涨 5 天则为优势股；间隔连续下跌 5 天则为劣质股。</p>
<p>第三步：将优质股权重调高 0.2，劣质股权重调低 0.2。</p>
<h3 id="策略代码-9">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略以0.8为初始权重跟踪指数标的沪深300中权重大于0.35%的成份股.</span></span><br><span class="line"><span class="string">个股所占的百分比为(0.8*成份股权重)*100%.然后根据个股是否:</span></span><br><span class="line"><span class="string">1.连续上涨5天 2.连续下跌5天</span></span><br><span class="line"><span class="string">来判定个股是否为强势股/弱势股,并对其把权重由0.8调至1.0或0.6</span></span><br><span class="line"><span class="string">回测时间为:2017-07-01 08:50:00到2017-10-01 17:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 资产配置的初始权重,配比为0.6-0.8-1.0</span></span><br><span class="line">    context.ratio = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取沪深300当时的成份股和相关数据</span></span><br><span class="line">    stock300 = get_history_constituents(index=<span class="string">&#x27;SHSE.000300&#x27;</span>, start_date=<span class="string">&#x27;2017-06-30&#x27;</span>, end_date=<span class="string">&#x27;2017-06-30&#x27;</span>)[<span class="number">0</span>][<span class="string">&#x27;constituents&#x27;</span>]</span><br><span class="line">    stock300_symbol = []</span><br><span class="line">    stock300_weight = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> stock300:</span><br><span class="line">        <span class="comment"># 保留权重大于0.35%的成份股</span></span><br><span class="line">        <span class="keyword">if</span> (stock300[key] / <span class="number">100</span>) &gt; <span class="number">0.0035</span>:</span><br><span class="line">            stock300_symbol.append(key)</span><br><span class="line">            stock300_weight.append(stock300[key] / <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    context.stock300 = DataFrame([stock300_weight], columns=stock300_symbol, index=[<span class="string">&#x27;weight&#x27;</span>]).T</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;选择的成分股权重总和为: &#x27;</span>, np.<span class="built_in">sum</span>(stock300_weight))</span><br><span class="line">    subscribe(symbols=stock300_symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=<span class="number">5</span>, wait_group=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 若没有仓位则按照初始权重开仓</span></span><br><span class="line">    <span class="keyword">for</span> bar <span class="keyword">in</span> bars:</span><br><span class="line">        symbol = bar[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        position = context.account().position(symbol=symbol, side=PositionSide_Long)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> position:</span><br><span class="line">            buy_percent = context.stock300[<span class="string">&#x27;weight&#x27;</span>][symbol] * context.ratio</span><br><span class="line">            order_target_percent(symbol=symbol, percent=buy_percent, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Long)</span><br><span class="line">            <span class="built_in">print</span>(symbol, <span class="string">&#x27;以市价单开多仓至仓位:&#x27;</span>, buy_percent)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 获取过去5天的价格数据,若连续上涨则为强势股,权重+0.2;若连续下跌则为弱势股,权重-0.2</span></span><br><span class="line">            recent_data = context.data(symbol=symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=<span class="number">5</span>, fields=<span class="string">&#x27;close&#x27;</span>)[<span class="string">&#x27;close&#x27;</span>].tolist()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">all</span>(np.diff(recent_data) &gt; <span class="number">0</span>):</span><br><span class="line">                buy_percent = context.stock300[<span class="string">&#x27;weight&#x27;</span>][symbol] * (context.ratio + <span class="number">0.2</span>)</span><br><span class="line">                order_target_percent(symbol=symbol, percent=buy_percent, order_type=OrderType_Market,</span><br><span class="line">                                     position_side=PositionSide_Long)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;强势股&#x27;</span>, symbol, <span class="string">&#x27;以市价单调多仓至仓位:&#x27;</span>, buy_percent)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">all</span>(np.diff(recent_data) &lt; <span class="number">0</span>):</span><br><span class="line">                buy_percent = context.stock300[<span class="string">&#x27;weight&#x27;</span>][symbol] * (context.ratio - <span class="number">0.2</span>)</span><br><span class="line">                order_target_percent(symbol=symbol, percent=buy_percent, order_type=OrderType_Market,</span><br><span class="line">                                     position_side=PositionSide_Long)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;弱势股&#x27;</span>, symbol, <span class="string">&#x27;以市价单调多仓至仓位:&#x27;</span>, buy_percent)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2017-07-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">10000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="跨品种套利-期货">跨品种套利(期货)</h2>
<h3 id="原理-11">原理</h3>
<h4 id="什么是跨品种套利？">什么是跨品种套利？</h4>
<p>当两个合约有很强的相关性时，可能存在相似的变动关系，两种合约之间的价差会维持在一定的水平上。当市场出现变化时，两种合约之间的价差会偏离均衡水平。此时，可以买入其中一份合约同时卖出其中一份合约，当价差恢复到正常水平时平仓，获取收益。</p>
<p>跨品种套利有以下几个特点：</p>
<ol>
<li>套利的两种资产必须有一定的相关性。</li>
<li>两种合约标的不同，到期时间相同。</li>
<li>两种资产之间的价差呈现一定规律。</li>
</ol>
<p>怎样确定合约之间有相关性？</p>
<p>最常用的方法是利用 EG 两步法对两个序列做协整检验，判断两个序列是否平稳。只有单整阶数相同，二者才有可能存在一定的关系。</p>
<h4 id="策略设计">策略设计</h4>
<p>传统利用价差进行跨品种套利的方法是计算出均值和方差，设定开仓、平仓和止损阈值。当新的价格达到阈值时，进行相应的开仓和平仓操作。</p>
<p>应该怎样确定均值？</p>
<p>均值的选取主要有两种方法，第一种方法是固定均值。先历史价格计算相应的阈值（比如利用 2017 年 2 月-2017 年 6 月的数据计算阈值，在 2019 年 7 月进行套利），再用最新价差进行比较，会发现前后均值差异很大。</p>
<p>因此，常用变动的均值设定阈值。即用过去 N 天两个标的之间差值的均值和方差。</p>
<h3 id="策略思路-3">策略思路</h3>
<p>第一步：选择相关性较高的两个合约，本例选择大商所的焦炭和焦煤。</p>
<p>第二步：以过去 30 个的 1d 频率 bar 的均值正负 0.75 个标准差作为开仓阈值，以正负 2 个标准差作为止损阈值。</p>
<p>第三步：最新价差上穿上界时做空价差，回归到均值附近平仓；下穿下界时做多价差，回归到均值附近平仓。设定止损点，触发止损点则全部平仓。</p>
<h3 id="策略代码-10">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略首先滚动计算过去30个1min收盘价的均值,然后用均值加减2个标准差得到布林线.</span></span><br><span class="line"><span class="string">若无仓位,在最新价差上穿上轨时做空价差;下穿下轨时做多价差</span></span><br><span class="line"><span class="string">若有仓位则在最新价差回归至上下轨水平内时平仓</span></span><br><span class="line"><span class="string">回测数据为:DCE.j1901和DCE.jm1901的1min数据</span></span><br><span class="line"><span class="string">回测时间为:2018-02-01 08:00:00到2018-12-31 08:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 选择的两个合约</span></span><br><span class="line">    context.symbol = [<span class="string">&#x27;DCE.j1901&#x27;</span>, <span class="string">&#x27;DCE.jm1901&#x27;</span>]</span><br><span class="line">    <span class="comment"># 订阅历史数据</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=<span class="number">11</span>, wait_group=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 数据提取</span></span><br><span class="line">    j_close = context.data(symbol=context.symbol[<span class="number">0</span>],frequency=<span class="string">&#x27;1d&#x27;</span>,fields=<span class="string">&#x27;close&#x27;</span>,count=<span class="number">31</span>).values</span><br><span class="line">    jm_close = context.data(symbol=context.symbol[<span class="number">1</span>],frequency=<span class="string">&#x27;1d&#x27;</span>,fields=<span class="string">&#x27;close&#x27;</span>,count=<span class="number">31</span>).values</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取最新价差</span></span><br><span class="line">    new_price = j_close[-<span class="number">1</span>] - jm_close[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算历史价差,上下限，止损点</span></span><br><span class="line">    spread_history = j_close[:-<span class="number">2</span>] - jm_close[:-<span class="number">2</span>]</span><br><span class="line">    context.spread_history_mean = np.mean(spread_history)</span><br><span class="line">    context.spread_history_std = np.std(spread_history)</span><br><span class="line">    context.up = context.spread_history_mean + <span class="number">0.75</span> * context.spread_history_std</span><br><span class="line">    context.down = context.spread_history_mean - <span class="number">0.75</span> * context.spread_history_std</span><br><span class="line">    context.up_stoppoint = context.spread_history_mean + <span class="number">2</span> * context.spread_history_std</span><br><span class="line">    context.down_stoppoint = context.spread_history_mean - <span class="number">2</span> * context.spread_history_std</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查持仓</span></span><br><span class="line">    position_jm_long = context.account().position(symbol=context.symbol[<span class="number">0</span>], side=<span class="number">1</span>)</span><br><span class="line">    position_jm_short = context.account().position(symbol=context.symbol[<span class="number">0</span>], side=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设计买卖信号</span></span><br><span class="line">    <span class="comment"># 设计开仓信号</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position_jm_short <span class="keyword">and</span> <span class="keyword">not</span> position_jm_long:</span><br><span class="line">        <span class="keyword">if</span> new_price &gt; context.up:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;做空价差组合&#x27;</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">0</span>],side=OrderSide_Sell,volume=<span class="number">1</span>,order_type=OrderType_Market, position_effect=<span class="number">1</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">1</span>], side=OrderSide_Buy, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_price &lt; context.down:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;做多价差组合&#x27;</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">0</span>], side=OrderSide_Buy, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">1</span>], side=OrderSide_Sell, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设计平仓信号</span></span><br><span class="line">    <span class="comment"># 持jm多仓时</span></span><br><span class="line">    <span class="keyword">if</span> position_jm_long:</span><br><span class="line">        <span class="keyword">if</span> new_price &gt;= context.spread_history_mean:</span><br><span class="line">            <span class="comment"># 价差回归到均值水平时，平仓</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;价差回归到均衡水平，平仓&#x27;</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">0</span>], side=OrderSide_Sell, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">1</span>], side=OrderSide_Buy, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_price &lt; context.down_stoppoint:</span><br><span class="line">            <span class="comment"># 价差达到止损位，平仓止损</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;价差超过止损点，平仓止损&#x27;</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">0</span>], side=OrderSide_Sell, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">1</span>], side=OrderSide_Buy, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 持jm空仓时</span></span><br><span class="line">    <span class="keyword">if</span> position_jm_short:</span><br><span class="line">        <span class="keyword">if</span> new_price &lt;= context.spread_history_mean:</span><br><span class="line">            <span class="comment"># 价差回归到均值水平时，平仓</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;价差回归到均衡水平，平仓&#x27;</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">0</span>], side=OrderSide_Buy, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">1</span>], side=OrderSide_Sell, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_price &gt; context.up_stoppoint:</span><br><span class="line">            <span class="comment"># 价差达到止损位，平仓止损</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;价差超过止损点，平仓止损&#x27;</span>)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">0</span>], side=OrderSide_Buy, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            order_volume(symbol=context.symbol[<span class="number">1</span>], side=OrderSide_Sell, volume=<span class="number">1</span>, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2018-02-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2018-12-31 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">2000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="日内回转交易-股票">日内回转交易(股票)</h2>
<h3 id="原理-12">原理</h3>
<h4 id="日内回转交易">日内回转交易</h4>
<p>日内回转交易，顾名思义就是在一天内完成“买”和“卖”两个相反方向的操作（可一次也可多次），也就是“T+0”交易。</p>
<p>日内回转可用于股票和期货。其中期货采用“T+0”交易制度，可以直接进行日内回转交易。由于 A 股采用的是“T+1”交易制度，无法直接进行日内回转交易，需要先配置一定的底仓再进行回转交易。</p>
<h4 id="股票的日内回转交易">股票的日内回转交易</h4>
<h5 id="怎样对股票进行日内回转交易？">怎样对股票进行日内回转交易？</h5>
<p>首先，在正式交易的前一个交易日配置一定的底仓。以 500 股为例，记做 total = 500。</p>
<p>然后开始正式的日内回转交易。</p>
<p>配置底仓的作用是利用替代法实现“T+0”。由于当天买入的股票当天不能卖出，但底仓是可以卖出的，用底仓替代新买入的股票进行卖出操作。假设在第二个交易日发生了 1 次买入，5 次卖出交易，每次交易买卖数量为 100 股。利用 turnaround = [0,0]变量记录每次交易的数量，也是当天收盘时需要回转的记录。其中第一个数据表示当日买入数量，第二个数据表示当日卖出数量。下表为单个交易日的买卖信号。</p>
<table>
<thead>
<tr>
<th>信号方向</th>
<th>数量</th>
<th>交易记录</th>
<th>剩余可回转的数量</th>
<th>总仓位</th>
</tr>
</thead>
<tbody>
<tr>
<td>买</td>
<td>100</td>
<td>[100,0]</td>
<td>500</td>
<td>600</td>
</tr>
<tr>
<td>卖</td>
<td>100</td>
<td>[100,100]</td>
<td>400</td>
<td>500</td>
</tr>
<tr>
<td>卖</td>
<td>100</td>
<td>[100,200]</td>
<td>300</td>
<td>400</td>
</tr>
<tr>
<td>卖</td>
<td>100</td>
<td>[100,300]</td>
<td>200</td>
<td>300</td>
</tr>
<tr>
<td>卖</td>
<td>100</td>
<td>[100,400]</td>
<td>100</td>
<td>200</td>
</tr>
</tbody>
</table>
<p><strong>假设在表的最后再加一个卖出信号是否可行？</strong></p>
<p>答案是<strong>不可行</strong>。</p>
<p>因为如果再加一个卖出信号，需要回转的股票数量变为[100,500]，即开多 100 股，开空 500 股。这就意味着在当天收盘之前，需要卖出 100 股，再买入 500 股进行回转。这个交易日内已经出现 5 次卖出信号，底仓的 500 股已经全部卖出，仅有 100 股今日买入的仓位，这部分股票是不能当日卖出的。所以，不能再添加卖出信号。</p>
<p>因此，在判断买入或卖出信号是否能执行时，隐含一个判断条件。即：</p>
<p>每次交易的数量 + 当日买入的数量（turnaround 的第一位）&lt; 底仓数量（以卖出信号为例）。</p>
<h4 id="MACD-指标简介">MACD 指标简介</h4>
<p>MACD 又称“异移动平均线”，是根据双指数移动平均线发展而来。由快的指数（常 12）减去慢的指数（常 26）得到 DIF，再用 2×（快线 DIF-DIF 的 9 日加权移动均线 DEA）得到 MACD 柱。</p>
<p>DIF 的计算方法为： DIF = 当天的 12 日指数移动平均值 - 当天的 26 日指数应对平均值。</p>
<h3 id="策略思路-4">策略思路</h3>
<p>第一步：设置变量</p>
<ul>
<li>context.first:底仓配置信号，0 表示未配置底仓；1 表示配置底仓。</li>
<li>context.trade_n:每次交易数量。</li>
<li>context.day:用来获取前一交易日的时间和最新交易日的时间，第一位是最新交易日，第二位是前一交易日。当二者不同时，意味着新的一天，需要初始化其他变量。</li>
<li>context.ending：开始回转信号，0 表示未触发；1 表示已触发。</li>
<li>context.turnaround：当日买卖股票操作记录，也是回转记录。第一位代表买入股数，第二位代表卖出股数。</li>
</ul>
<p>第二步：计算 MACD 指标，设计交易信号</p>
<ul>
<li>当 MACD 小于 0 时，买入对应股票 100 手；</li>
<li>当 MACD 大于 0 时，卖出对应股票 100 手;</li>
</ul>
<p>第三步：接近收盘时，全部回转</p>
<h3 id="策略代码-11">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略首先买入SHSE.600000股票10000股</span></span><br><span class="line"><span class="string">随后根据60s的数据计算MACD(12,26,9),</span></span><br><span class="line"><span class="string">在MACD&gt;0的时候买入100股;在MACD&lt;0的时候卖出100股</span></span><br><span class="line"><span class="string">但每日操作的股票数不超过原有仓位,并于收盘前把仓位调整至开盘前的仓位</span></span><br><span class="line"><span class="string">回测数据为:SHSE.600000的60s数据</span></span><br><span class="line"><span class="string">回测时间为:2017-09-01 08:00:00到2017-10-01 16:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 设置标的股票</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHSE.600000&#x27;</span></span><br><span class="line">    <span class="comment"># 用于判定第一个仓位是否成功开仓</span></span><br><span class="line">    context.first = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 订阅浦发银行, bar频率为1min</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">35</span>)</span><br><span class="line">    <span class="comment"># 日内回转每次交易100股</span></span><br><span class="line">    context.trade_n = <span class="number">100</span></span><br><span class="line">    <span class="comment"># 获取昨今天的时间</span></span><br><span class="line">    context.day = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 用于判断是否到达接近收盘，所以不再交易</span></span><br><span class="line">    context.ending = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    bar = bars[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 配置底仓</span></span><br><span class="line">    <span class="keyword">if</span> context.first == <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 需要保持的总仓位</span></span><br><span class="line">        context.total = <span class="number">10000</span></span><br><span class="line">        <span class="comment"># 购买10000股浦发银行股票</span></span><br><span class="line">        order_volume(symbol=context.symbol, volume=context.total, side=OrderSide_Buy,</span><br><span class="line">                     order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">        <span class="built_in">print</span>(context.symbol, <span class="string">&#x27;以市价单开多仓10000股&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        context.first = <span class="number">1.</span></span><br><span class="line">        day = bar.bob.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">        context.day[-<span class="number">1</span>] = <span class="built_in">int</span>(day[-<span class="number">2</span>:])</span><br><span class="line">        <span class="comment"># 每天的仓位操作</span></span><br><span class="line">        context.turnaround = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新最新的日期</span></span><br><span class="line">    day = bar.bob.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">    context.day[<span class="number">0</span>] = bar.bob.day</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若为新的一天,获取可用于回转的昨仓</span></span><br><span class="line">    <span class="keyword">if</span> context.day[<span class="number">0</span>] != context.day[-<span class="number">1</span>]:</span><br><span class="line">        context.ending = <span class="number">0</span></span><br><span class="line">        context.turnaround = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果接近收盘，则不再交易</span></span><br><span class="line">    <span class="keyword">if</span> context.ending == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若有可用的昨仓则操作</span></span><br><span class="line">    <span class="keyword">if</span> context.total &gt;= <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 获取时间序列数据</span></span><br><span class="line">        symbol = bar[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        recent_data = context.data(symbol=symbol, frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">35</span>, fields=<span class="string">&#x27;close&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算MACD线</span></span><br><span class="line">        macd = talib.MACD(recent_data[<span class="string">&#x27;close&#x27;</span>].values)[<span class="number">0</span>][-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据MACD&gt;0则开仓,小于0则平仓</span></span><br><span class="line">        <span class="keyword">if</span> macd &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 多空单向操作都不能超过昨仓位,否则最后无法调回原仓位</span></span><br><span class="line">            <span class="keyword">if</span> context.turnaround[<span class="number">0</span>] + context.trade_n &lt; context.total:</span><br><span class="line">                <span class="comment"># 计算累计仓位</span></span><br><span class="line">                context.turnaround[<span class="number">0</span>] += context.trade_n</span><br><span class="line">                order_volume(symbol=context.symbol, volume=context.trade_n, side=OrderSide_Buy,</span><br><span class="line">                             order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">                <span class="built_in">print</span>(symbol, <span class="string">&#x27;市价单开多仓&#x27;</span>, context.trade_n, <span class="string">&#x27;股&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> macd &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> context.turnaround[<span class="number">1</span>] + context.trade_n &lt; context.total:</span><br><span class="line">                context.turnaround[<span class="number">1</span>] += context.trade_n</span><br><span class="line">                order_volume(symbol=context.symbol, volume=context.trade_n, side=OrderSide_Sell,</span><br><span class="line">                             order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">                <span class="built_in">print</span>(symbol, <span class="string">&#x27;市价单开空仓&#x27;</span>, context.trade_n, <span class="string">&#x27;股&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 临近收盘时若仓位数不等于昨仓则回转所有仓位</span></span><br><span class="line">        <span class="keyword">if</span> day[<span class="number">11</span>:<span class="number">16</span>] == <span class="string">&#x27;14:55&#x27;</span> <span class="keyword">or</span> day[<span class="number">11</span>:<span class="number">16</span>] == <span class="string">&#x27;14:57&#x27;</span>:</span><br><span class="line">            position = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> position[<span class="string">&#x27;volume&#x27;</span>] != context.total:</span><br><span class="line">                order_target_volume(symbol=context.symbol, volume=context.total, order_type=OrderType_Market,</span><br><span class="line">                                    position_side=PositionSide_Long)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;市价单回转仓位操作...&#x27;</span>)</span><br><span class="line">                context.ending = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新过去的日期数据</span></span><br><span class="line">        context.day[-<span class="number">1</span>] = context.day[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2017-09-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">2000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="跨期套利-期货">跨期套利(期货)</h2>
<h3 id="原理-13">原理</h3>
<h4 id="什么是跨期套利？">什么是跨期套利？</h4>
<p>跨期套利是指在同益市场利用标的相同、交割月份不同的商品期货合约进行长短期套利的策略。跨期套利本质上是一种风险对冲，当价格出现单方向变动时，单边投机者要承担价格反向变动的风险，而跨期套利过滤了大部分的价格波动风险，只承担价差反向变动的风险。</p>
<p>跨期套利相较于跨品种套利而言更复杂一些。跨期套利分为牛市套利、熊市套利、牛熊交换套利。每种套利方式下还有正向套利和反向套利。不管是哪种套利方式，其核心都是认为“价差会向均值回归”。因此，在价差偏离均值水平时，按照判断买入被低估的合约，卖出被高估的合约。</p>
<h4 id="套利方法">套利方法</h4>
<table>
<thead>
<tr>
<th>价差（近-远）</th>
<th>未来价</th>
<th>原理</th>
<th>操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>偏大</td>
<td>上涨/下跌</td>
<td>近月增长 &gt; 远月增长</td>
<td>买近卖远</td>
</tr>
<tr>
<td>偏大</td>
<td>上涨/下跌</td>
<td>近月下跌 &lt; 远月下跌</td>
<td>买近卖远</td>
</tr>
<tr>
<td>偏小</td>
<td>上涨/下跌</td>
<td>近月增长 &lt; 远月增长</td>
<td>卖近买远</td>
</tr>
<tr>
<td>偏小</td>
<td>上涨/下跌</td>
<td>近月下跌 &gt; 远月下跌</td>
<td>卖近买远</td>
</tr>
</tbody>
</table>
<h4 id="协整检验">协整检验</h4>
<p>要想判断两个序列之间是否存在关系，需要对序列进行协整检验。</p>
<p>两个序列都为单整序列，残差序列也平稳，说明二者之间存在长期稳定的均衡关系。</p>
<h3 id="策略步骤-3">策略步骤</h3>
<p>第一步：选择同一标的不同月份的合约，本策略以豆粕为例。</p>
<p>第二步：计算价差的上下轨。</p>
<p>第三步：设计信号。价差上穿上轨，买近卖远；价差下穿下轨，卖近买远。</p>
<p>价差达到止损点时平仓，价差回归到均值附近时平仓。</p>
<h3 id="策略代码-12">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">通过计算两个真实价格序列回归残差的0.9个标准差上下轨,并在价差突破上轨的时候做空价差,价差突破下轨的时候做多价差</span></span><br><span class="line"><span class="string">并在回归至标准差水平内的时候平仓</span></span><br><span class="line"><span class="string">回测数据为:DCE.m1801和DCE.m1805的1min数据</span></span><br><span class="line"><span class="string">回测时间为:2017-09-25 08:00:00到2017-10-01 15:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    context.goods = [<span class="string">&#x27;DCE.m1801&#x27;</span>, <span class="string">&#x27;DCE.m1805&#x27;</span>]</span><br><span class="line">    <span class="comment"># 订阅品种数据</span></span><br><span class="line">    subscribe(symbols=context.goods, frequency=<span class="string">&#x27;1d&#x27;</span>, count=<span class="number">31</span>, wait_group=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 获取历史数据</span></span><br><span class="line">    close_1801 = context.data(symbol=context.goods[<span class="number">0</span>], frequency=<span class="string">&#x27;1d&#x27;</span>, count=<span class="number">31</span>, fields=<span class="string">&#x27;close&#x27;</span>)[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">    close_1805 = context.data(symbol=context.goods[<span class="number">1</span>], frequency=<span class="string">&#x27;1d&#x27;</span>, count=<span class="number">31</span>, fields=<span class="string">&#x27;close&#x27;</span>)[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算上下轨</span></span><br><span class="line">    spread = close_1801[:-<span class="number">2</span>] - close_1805[:-<span class="number">2</span>]</span><br><span class="line">    spread_new = close_1801[-<span class="number">1</span>] - close_1805[-<span class="number">1</span>]</span><br><span class="line">    up = np.mean(spread) + <span class="number">0.75</span> * np.std(spread)</span><br><span class="line">    down = np.mean(spread) - <span class="number">0.75</span> * np.std(spread)</span><br><span class="line">    up_stop = np.mean(spread) + <span class="number">2</span> * np.std(spread)</span><br><span class="line">    down_stop = np.mean(spread) - <span class="number">2</span> * np.std(spread)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取仓位</span></span><br><span class="line">    position1801_long = context.account().position(symbol = context.goods[<span class="number">0</span>],side =PositionSide_Long)</span><br><span class="line">    position1801_short = context.account().position(symbol = context.goods[<span class="number">0</span>],side =PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 没有仓位时</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position1801_short <span class="keyword">and</span> <span class="keyword">not</span> position1801_long:</span><br><span class="line">        <span class="comment"># 上穿上轨时，买近卖远</span></span><br><span class="line">        <span class="keyword">if</span> spread_new &gt; up:</span><br><span class="line">            order_volume(symbol=context.goods[<span class="number">0</span>], volume=<span class="number">1</span>, order_type=OrderType_Market, side=OrderSide_Buy, position_effect=PositionEffect_Open)</span><br><span class="line">            order_volume(symbol=context.goods[<span class="number">1</span>], volume=<span class="number">1</span>, order_type=OrderType_Market, side=OrderSide_Sell, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;上穿上轨，买近卖远&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 下穿下轨时，卖近买远</span></span><br><span class="line">        <span class="keyword">if</span> spread_new &lt; down:</span><br><span class="line">            order_volume(symbol=context.goods[<span class="number">0</span>], volume=<span class="number">1</span>, order_type=OrderType_Market, side=OrderSide_Sell, position_effect=PositionEffect_Open)</span><br><span class="line">            order_volume(symbol=context.goods[<span class="number">1</span>], volume=<span class="number">1</span>, order_type=OrderType_Market, side=OrderSide_Buy, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;下穿下轨，卖近买远&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 价差回归到上轨时，平仓</span></span><br><span class="line">    <span class="keyword">if</span> position1801_long:</span><br><span class="line">        <span class="keyword">if</span> spread_new &lt;= np.mean(spread):</span><br><span class="line">            order_close_all()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;价差回归，平仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> spread_new &gt; up_stop:</span><br><span class="line">            order_close_all()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;达到止损点，全部平仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 价差回归到下轨时，平仓</span></span><br><span class="line">    <span class="keyword">if</span> position1801_short:</span><br><span class="line">        <span class="keyword">if</span> spread_new &gt;= np.mean(spread):</span><br><span class="line">            order_close_all()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;价差回归，平全部仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> spread_new &lt; down_stop:</span><br><span class="line">            order_close_all()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;达到止损点，全部平仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2017-07-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-12-31 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">2000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="海龟交易法-期货">海龟交易法(期货)</h2>
<h3 id="原理-14">原理</h3>
<h4 id="起源">起源</h4>
<p>海龟交易思想起源于上世纪八十年代的美国。理查德丹尼斯与好友比尔打赌，主题是一个成功的交易员是天生的还是后天的。理查德用十年时间证明了通过日常系统培训，交易员可以通过后天培训成为一名优秀的交易者。这套培训系统就是海龟交易系统。</p>
<p>海龟交易系统是一个完整的、机械的交易思想，可以系统地完成整个交易过程。它包括了买卖什么、头寸规模、何时买卖、何时退出等一系列交易策略，是一个趋势交易策略。它最显著的特点是捕捉中长期趋势，力求在短期内获得最大的收益。</p>
<h4 id="建仓资金">建仓资金</h4>
<p>海龟交易法将建仓资金按照一定比例划分为若干个小部分，每次建仓头寸和加仓规模都与波动量 N（又称平均真实波动振幅 average true range ATR）有关。ATR 是日内指数最大波动的平均振幅，由当日最高、最低价和上一交易日的收盘价决定。</p>
<h5 id="ATR">ATR</h5>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>T</mi><mi>R</mi><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>H</mi><mo>−</mo><mi>L</mi><mo separator="true">,</mo><mi>H</mi><mo>−</mo><mi>P</mi><mi>D</mi><mi>C</mi><mo separator="true">,</mo><mi>P</mi><mi>D</mi><mi>C</mi><mo>−</mo><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">TR = max(H - L, H - PDC, PDC - L)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">TR</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中 PDC 是前一交易日的收盘价，ATR 就是 TR 在 N 天内的均值。</p>
<h5 id="价值波动量">价值波动量</h5>
<p>利用 N 值来体现价值波动量 DV：DV = N * 合约每点价值</p>
<p>其中每点代表的价值量是指每一个指数点数所代表的价格。</p>
<p>每一次开仓交易合约数 unit 的确定是将总资产的 1%除以 DV 得到。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>U</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mtext>总资产的</mtext><mn>1</mn><mi mathvariant="normal">%</mi></mrow><mrow><mi>D</mi><mi>V</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Unit = \frac{总资产的1\%}{DV}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">ni</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord cjk_fallback">总资产的</span><span class="mord">1%</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h4 id="入市信号">入市信号</h4>
<p>海龟交易法使用的是以一个理查德唐奇安的通道突破系统为基础的入市系统。唐奇安通道分为系统一和系统二，对应短期突破和中长期突破。其中，短期突破系统是以 20 日（最高价或最低价）突破为基础，当价格突破 20 日价格即为入市信号；中长期系统是当盘中价格突破过去 55 日价格为入市信号。</p>
<h4 id="加仓和止损">加仓和止损</h4>
<p>海龟交易法的加仓规则是当捕捉到入市信号后建立第一个交易单位的头寸，市价继续向盈利方向突破 1/2N 时加仓。</p>
<p>止损位为 2N,同加仓一样采用平均真实振幅 N 值为止损单位。每加仓一次，止损位就提高 1/2N。</p>
<h4 id="止盈">止盈</h4>
<p>短期：多头头寸在突破过去 10 日最低价处止盈离市，空头头寸在突破过去 10 日最高价处止盈离市。<br>
中长期：多头头寸在突破过去 20 日最低价处止盈离市，空头头寸在突破过去 20 日最高价处止盈离市。</p>
<h3 id="策略思路-5">策略思路</h3>
<p>第一步：获取历史数据，计算唐奇安通道和 ATR</p>
<p>第二步：当突破唐奇安通道时，开仓。</p>
<p>第三步：计算加仓和止损信号。</p>
<h3 id="策略代码-13">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">以短期为例：20日线</span></span><br><span class="line"><span class="string">第一步：获取历史数据，计算唐奇安通道和ATR</span></span><br><span class="line"><span class="string">第二步：当突破唐奇安通道时，开仓。</span></span><br><span class="line"><span class="string">第三步：计算加仓和止损信号。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 设置计算唐奇安通道的参数</span></span><br><span class="line">    context.n = <span class="number">20</span></span><br><span class="line">    <span class="comment"># 设置合约标的</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;DCE.i2012&#x27;</span></span><br><span class="line">    <span class="comment"># 设置交易最大资金比率</span></span><br><span class="line">    context.ratio = <span class="number">0.8</span></span><br><span class="line">    <span class="comment"># 订阅数据</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># 获取当前时间</span></span><br><span class="line">    time = context.now.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>)</span><br><span class="line">    <span class="comment"># 如果策略执行时间点是交易时间段，则直接执行algo定义atr等参数，以防直接进入on_bar()导致atr等未定义</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;09:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;15:00:00&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;21:00:00&#x27;</span> &lt; time &lt; <span class="string">&#x27;23:00:00&#x27;</span>:</span><br><span class="line">        algo(context)</span><br><span class="line">    <span class="comment"># 如果是交易时间段，等到开盘时间确保进入algo()</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;09:00:00&#x27;</span>)</span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1d&#x27;</span>, time_rule=<span class="string">&#x27;21:00:00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 计算通道的数据:当日最低、最高、上一交易日收盘</span></span><br><span class="line">    <span class="comment"># 注：由于talib库计算ATR的结果与公式求得的结果不符，所以这里利用公式计算ATR</span></span><br><span class="line">    <span class="comment"># 如果是回测模式,当天的数据直接用history取到</span></span><br><span class="line">    <span class="keyword">if</span> context.mode == <span class="number">2</span>:</span><br><span class="line">        data = history_n(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.n+<span class="number">1</span>, end_time=context.now, fields=<span class="string">&#x27;close,high,low,bob&#x27;</span>, df=<span class="literal">True</span>) <span class="comment"># 计算ATR</span></span><br><span class="line">        tr_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data)-<span class="number">1</span>):</span><br><span class="line">            tr = <span class="built_in">max</span>((data[<span class="string">&#x27;high&#x27;</span>].iloc[i] - data[<span class="string">&#x27;low&#x27;</span>].iloc[i]), data[<span class="string">&#x27;close&#x27;</span>].shift(-<span class="number">1</span>).iloc[i] - data[<span class="string">&#x27;high&#x27;</span>].iloc[i],</span><br><span class="line">                     data[<span class="string">&#x27;close&#x27;</span>].shift(-<span class="number">1</span>).iloc[i] - data[<span class="string">&#x27;low&#x27;</span>].iloc[i])</span><br><span class="line">            tr_list.append(tr)</span><br><span class="line">        context.atr = <span class="built_in">int</span>(np.floor(np.mean(tr_list)))</span><br><span class="line">        context.atr_half = <span class="built_in">int</span>(np.floor(<span class="number">0.5</span> * context.atr))</span><br><span class="line">        <span class="comment"># 计算唐奇安通道</span></span><br><span class="line">        context.don_open = np.<span class="built_in">max</span>(data[<span class="string">&#x27;high&#x27;</span>].values[-context.n:])</span><br><span class="line">        context.don_close = np.<span class="built_in">min</span>(data[<span class="string">&#x27;low&#x27;</span>].values[-context.n:])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是实时模式，当天的数据需要用current取到</span></span><br><span class="line">    <span class="keyword">if</span> context.mode == <span class="number">1</span>:</span><br><span class="line">        data = history_n(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.n, end_time=context.now, fields=<span class="string">&#x27;close,high,low&#x27;</span>,</span><br><span class="line">                         df=<span class="literal">True</span>)  <span class="comment"># 计算ATR</span></span><br><span class="line">        current_data = current(symbols=context.symbol)   <span class="comment"># 最新一个交易日的最高、最低</span></span><br><span class="line">        tr_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(data)):</span><br><span class="line">            tr = <span class="built_in">max</span>((data[<span class="string">&#x27;high&#x27;</span>].iloc[i] - data[<span class="string">&#x27;low&#x27;</span>].iloc[i]),</span><br><span class="line">                     data[<span class="string">&#x27;close&#x27;</span>].shift(-<span class="number">1</span>).iloc[i] - data[<span class="string">&#x27;high&#x27;</span>].iloc[i],</span><br><span class="line">                     data[<span class="string">&#x27;close&#x27;</span>].shift(-<span class="number">1</span>).iloc[i] - data[<span class="string">&#x27;low&#x27;</span>].iloc[i])</span><br><span class="line">            tr_list.append(tr)</span><br><span class="line">        <span class="comment"># 把最新一期tr加入列表中</span></span><br><span class="line">        tr_new = <span class="built_in">max</span>((current_data[<span class="number">0</span>][<span class="string">&#x27;high&#x27;</span>] - current_data[<span class="number">0</span>][<span class="string">&#x27;low&#x27;</span>]),</span><br><span class="line">                     data[<span class="string">&#x27;close&#x27;</span>].iloc[-<span class="number">1</span>] - current_data[<span class="number">0</span>][<span class="string">&#x27;high&#x27;</span>],</span><br><span class="line">                     data[<span class="string">&#x27;close&#x27;</span>].iloc[-<span class="number">1</span>] - current_data[<span class="number">0</span>][<span class="string">&#x27;low&#x27;</span>])</span><br><span class="line">        tr_list.append(tr_new)</span><br><span class="line">        context.atr = <span class="built_in">int</span>(np.floor(np.mean(tr_list)))</span><br><span class="line">        context.atr_half = <span class="built_in">int</span>(np.floor(<span class="number">0.5</span> * context.atr))</span><br><span class="line">        <span class="comment"># 计算唐奇安通道</span></span><br><span class="line">        context.don_open = np.<span class="built_in">max</span>(data[<span class="string">&#x27;high&#x27;</span>].values[-context.n:])</span><br><span class="line">        context.don_close = np.<span class="built_in">min</span>(data[<span class="string">&#x27;low&#x27;</span>].values[-context.n:])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算加仓点和止损点</span></span><br><span class="line">    context.long_add_point = context.don_open + context.atr_half</span><br><span class="line">    context.long_stop_loss = context.don_open - context.atr_half</span><br><span class="line">    context.short_add_point = context.don_close - context.atr_half</span><br><span class="line">    context.short_stop_loss = context.don_close + context.atr_half</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    <span class="comment"># 提取数据</span></span><br><span class="line">    symbol = bars[<span class="number">0</span>][<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">    recent_data = context.data(symbol=context.symbol, frequency=<span class="string">&#x27;60s&#x27;</span>, count=<span class="number">2</span>, fields=<span class="string">&#x27;close,high,low&#x27;</span>)</span><br><span class="line">    close = recent_data[<span class="string">&#x27;close&#x27;</span>].values[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 账户仓位情况</span></span><br><span class="line">    position_long = context.account().position(symbol=symbol, side=PositionSide_Long)</span><br><span class="line">    position_short = context.account().position(symbol=symbol, side=PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 当无持仓时</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position_long <span class="keyword">and</span> <span class="keyword">not</span> position_short:</span><br><span class="line">        <span class="comment"># 如果向上突破唐奇安通道，则开多</span></span><br><span class="line">        <span class="keyword">if</span> close &gt; context.don_open:</span><br><span class="line">            order_volume(symbol=symbol, side=OrderSide_Buy, volume=context.atr, order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;开多仓atr&#x27;</span>)</span><br><span class="line">        <span class="comment"># 如果向下突破唐奇安通道，则开空</span></span><br><span class="line">        <span class="keyword">if</span> close &lt; context.don_close:</span><br><span class="line">            order_volume(symbol=symbol, side=OrderSide_Sell, volume=context.atr, order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;开空仓atr&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 有持仓时</span></span><br><span class="line">    <span class="comment"># 持多仓，继续突破（加仓）</span></span><br><span class="line">    <span class="keyword">if</span> position_long:</span><br><span class="line">        <span class="comment"># 当突破1/2atr时加仓</span></span><br><span class="line">        <span class="keyword">if</span> close &gt; context.long_add_point:</span><br><span class="line">            order_volume(symbol=symbol, volume=context.atr_half, side=OrderSide_Buy, order_type=OrderType_Market,position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;继续加仓0.5atr&#x27;</span>)</span><br><span class="line">            context.long_add_point += context.atr_half</span><br><span class="line">            context.long_stop_loss += context.atr_half</span><br><span class="line">        <span class="comment"># 持多仓，止损位计算</span></span><br><span class="line">        <span class="keyword">if</span> close &lt; context.long_stop_loss:</span><br><span class="line">            volume_hold = position_long[<span class="string">&#x27;volume&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> volume_hold &gt;= context.atr_half:</span><br><span class="line">                order_volume(symbol=symbol, volume=context.atr_half, side=OrderSide_Sell, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                order_volume(symbol=symbol, volume=volume_hold, side=OrderSide_Sell, order_type=OrderType_Market,position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;平多仓0.5atr&#x27;</span>)</span><br><span class="line">            context.long_add_point -= context.atr_half</span><br><span class="line">            context.long_stop_loss -= context.atr_half</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 持空仓，继续突破（加仓）</span></span><br><span class="line">    <span class="keyword">if</span> position_short:</span><br><span class="line">        <span class="comment"># 当跌破加仓点时加仓</span></span><br><span class="line">        <span class="keyword">if</span> close &lt; context.short_add_point:</span><br><span class="line">            order_volume(symbol = symbol, volume=context.atr_half, side=OrderSide_Sell, order_type=OrderType_Market, position_effect=PositionEffect_Open)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;继续加仓0.5atr&#x27;</span>)</span><br><span class="line">            context.short_add_point -= context.atr_half</span><br><span class="line">            context.short_stop_loss -= context.atr_half</span><br><span class="line">        <span class="comment"># 持多仓，止损位计算</span></span><br><span class="line">        <span class="keyword">if</span> close &gt; context.short_stop_loss:</span><br><span class="line">            volume_hold = position_short[<span class="string">&#x27;volume&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> volume_hold &gt;= context.atr_half:</span><br><span class="line">                order_volume(symbol=symbol, volume=context.atr_half, side=OrderSide_Buy, order_type=OrderType_Market, position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                order_volume(symbol=symbol, volume=volume_hold, side=OrderSide_Buy, order_type=OrderType_Market,position_effect=PositionEffect_Close)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;平空仓0.5atr&#x27;</span>)</span><br><span class="line">            context.short_add_point += context.atr_half</span><br><span class="line">            context.short_stop_loss += context.atr_half</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2020-02-15 09:15:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-09-01 15:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">1000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="做市商交易-期货">做市商交易(期货)</h2>
<h3 id="原理-15">原理</h3>
<h4 id="做市商制度">做市商制度</h4>
<p>做市商制度是一种报价驱动制度。做市商根据自己的判断，不断地报出买入报价和卖出报价，以自有资金与投资者进行交易。做市商获取的收益就是买入价和卖出价的价差。</p>
<p>假设做市商以 6344 卖出一手合约，同时以 6333 买入一手合约。如果都成交，做市商可净获利 11 个点。但如果当时合约价格持续走高或走低，做市商没有对手方能够成交，这时就不得不提高自己的买价或降低自己的卖价进行交易，做市商就会亏损。因此，做市商并不是稳赚不赔的。</p>
<h3 id="策略思路-6">策略思路</h3>
<p>第一步：订阅 tick 数据（只有最近 3 个月数据）</p>
<p>第二步：获取 tick 数据中的卖一和买一价格。</p>
<p>第三步：以买一价格开多，以卖一价格开空。以卖一价格平多，以买一价格平空。</p>
<h3 id="策略代码-14">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略通过不断对DCE.y2105进行:</span></span><br><span class="line"><span class="string">买(卖)一价现价单开多(空)仓和卖(买)一价平多(空)仓来做市</span></span><br><span class="line"><span class="string">并以此赚取差价</span></span><br><span class="line"><span class="string">回测数据为:DCE.y2105的tick数据</span></span><br><span class="line"><span class="string">回测时间为:2021-01-29 11:25:00到2021-01-29 11:30:00</span></span><br><span class="line"><span class="string">需要特别注意的是:本平台对于回测对限价单固定完全成交,本例子 仅供参考.</span></span><br><span class="line"><span class="string">敬请通过适当调整回测参数</span></span><br><span class="line"><span class="string">1.backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">2.backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">3.backtest_transaction_ratio回测成交比例</span></span><br><span class="line"><span class="string">以及优化策略逻辑来达到更贴近实际的回测效果</span></span><br><span class="line"><span class="string">目前只支持最近三个月的tick数据，回测时间和标的需要修改</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 订阅DCE.y2105的tick数据</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;DCE.y2105&#x27;</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;tick&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_tick</span>(<span class="params">context, tick</span>):</span><br><span class="line">    quotes = tick[<span class="string">&#x27;quotes&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 获取持有的多仓</span></span><br><span class="line">    position_long = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line">    <span class="comment"># 获取持有的空仓</span></span><br><span class="line">    position_short = context.account().position(symbol=context.symbol, side=PositionSide_Short)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 没有仓位则双向开限价单</span></span><br><span class="line">    <span class="comment"># 若有仓位则限价单平仓</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position_long:</span><br><span class="line">        <span class="comment"># 获取买一价</span></span><br><span class="line">        price = quotes[<span class="string">&#x27;bid_p&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;买一价为: &#x27;</span>, price)</span><br><span class="line">        order_target_volume(symbol=context.symbol, volume=<span class="number">1</span>, price=price, order_type=OrderType_Limit,</span><br><span class="line">                            position_side=PositionSide_Long)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;DCE.y2105开限价单多仓1手&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 获取卖一价</span></span><br><span class="line">        price = quotes[<span class="string">&#x27;ask_p&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;卖一价为: &#x27;</span>, price)</span><br><span class="line">        order_target_volume(symbol=context.symbol, volume=<span class="number">0</span>, price=price, order_type=OrderType_Limit,</span><br><span class="line">                            position_side=PositionSide_Long)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;DCE.y2105平限价单多仓1手&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position_short:</span><br><span class="line">        <span class="comment"># 获取卖一价</span></span><br><span class="line">        price = quotes[<span class="string">&#x27;ask_p&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;卖一价为: &#x27;</span>, price)</span><br><span class="line">        order_target_volume(symbol=context.symbol, volume=<span class="number">1</span>, price=price, order_type=OrderType_Limit,</span><br><span class="line">                            position_side=PositionSide_Short)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;DCE.y2105卖一价开限价单空仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 获取买一价</span></span><br><span class="line">        price = quotes[<span class="string">&#x27;bid_p&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;买一价为: &#x27;</span>, price)</span><br><span class="line">        order_target_volume(symbol=context.symbol, volume=<span class="number">0</span>, price=price, order_type=OrderType_Limit,</span><br><span class="line">                            position_side=PositionSide_Short)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;DCE.y2105买一价平限价单空仓&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    backtest_transaction_ratio回测成交比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2021-01-20 11:25:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2021-01-20 11:30:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">500000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.00006</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_transaction_ratio=<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<h2 id="行业轮动-股票">行业轮动(股票)</h2>
<h3 id="原理-16">原理</h3>
<h4 id="行业轮动现象">行业轮动现象</h4>
<p>在某一段时间内，某一行业或某几个行业组内股票价格共同上涨或下降的现象。</p>
<p>行业轮动策略是根据行业轮动现象做成的策略，利用行业趋势进行获利的方法，属于主动交易策略。其本质是通过一段时期的市场表现，力求抓住表现较好的行业以及投资品种，选择不同时期的强势行业进行获利。</p>
<h4 id="行业轮动的原因">行业轮动的原因</h4>
<h5 id="原因-1：行业周期">原因 1：行业周期</h5>
<p>行业的成长周期可以分为初创期、成长期、成熟期和衰退期，一般行业会按照这个周期运行。初创期属于行业刚刚起步阶段，风险高、收益小。成长期内风险高、收益高。处于成熟期的企业风险低、收益高。处于衰退期的企业风险低、收益低。在一段时间内，不同的行业会处于不同的行业周期，在时间维度上看会呈现行业轮动现象。</p>
<h5 id="原因-2：国家政策">原因 2：国家政策</h5>
<p>国家政策对我国资本市场有重大影响。我国每年的财政政策和货币政策都是市场关注的热点，货币政策和财政政策会释放出影响市场的信息，如利率。当政策释放出下调利率的信号，就为资金需求量大、项目周期长的行业缓解了压力，如房地产行业，这时对于这类行业利好，相应的股价就会上涨。</p>
<h5 id="原因-3：重大事件">原因 3：重大事件</h5>
<p>资本市场对于消息的反应是迅速的。根据有效市场理论，在半强式有效市场下，一切已公开的信息都会反映在股价当中。以疫情为例，消息一出迅速拉动医疗行业股价水平，带动行业增长。</p>
<h4 id="行业轮动下资产配置">行业轮动下资产配置</h4>
<h5 id="策略设计-2">策略设计</h5>
<ul>
<li>行业动量策略</li>
</ul>
<p>部分研究表明，行业在日、月频率上会存在动量现象，在周频率上会存在反转现象，也就是行业间轮动。因此，在日和月频率上可以利用行业动量设计策略，如果是在周频率上可以利用反转效应设计策略。</p>
<p>（引自：武文超. 中国 A 股市场的行业轮动现象分析——基于动量和反转交易策略的检验[J]. 金融理论与实践, 2014, 000(009):111-114.）</p>
<ul>
<li>行业因子策略</li>
</ul>
<p>将行业变量作为一个因子放入多因子模型中，利用多因子模型预测各个行业的周期收益率，采用滚动预测方法每次得到一个样本外预测值，根据这些预测值判断该买入哪些行业，卖出哪些行业。</p>
<p>（引自：高波, 任若恩. 基于主成分回归模型的行业轮动策略及其业绩评价[J]. 数学的实践与认识, 2016, 46(019):82-92.）</p>
<h3 id="策略思路-7">策略思路</h3>
<p>策略示例采用第一种策略构建方法，利用行业动量设计策略。为了提高策略速度，以 6 个行业为例进行演示。</p>
<p>第一步：确定行业指数，获取行业指数收益率。</p>
<p>第二步：根据行业动量获取最佳行业指数。</p>
<p>第三步：在最佳行业中，选择最大市值的 5 支股票买入。</p>
<h3 id="策略代码-15">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略每隔1个月定时触发计算SHSE.000910.SHSE.000909.SHSE.000911.SHSE.000912.SHSE.000913.SHSE.000914</span></span><br><span class="line"><span class="string">(300工业.300材料.300可选.300消费.300医药.300金融)这几个行业指数过去</span></span><br><span class="line"><span class="string">20个交易日的收益率并选取了收益率最高的指数的成份股获取并获取了他们的市值数据</span></span><br><span class="line"><span class="string">随后把仓位调整至市值最大的5只股票上</span></span><br><span class="line"><span class="string">回测数据为:SHSE.000910.SHSE.000909.SHSE.000911.SHSE.000912.SHSE.000913.SHSE.000914和他们的成份股</span></span><br><span class="line"><span class="string">回测时间为:2017-07-01 08:00:00到2017-10-01 16:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 每月第一个交易日的09:40 定时执行algo任务（仿真和实盘时不支持该频率）</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1m&#x27;</span>, time_rule=<span class="string">&#x27;09:40:00&#x27;</span>)</span><br><span class="line">    <span class="comment"># 用于筛选的行业指数</span></span><br><span class="line">    context.index = [<span class="string">&#x27;SHSE.000910&#x27;</span>, <span class="string">&#x27;SHSE.000909&#x27;</span>, <span class="string">&#x27;SHSE.000911&#x27;</span>, <span class="string">&#x27;SHSE.000912&#x27;</span>, <span class="string">&#x27;SHSE.000913&#x27;</span>, <span class="string">&#x27;SHSE.000914&#x27;</span>]</span><br><span class="line">    <span class="comment"># 用于统计数据的天数</span></span><br><span class="line">    context.date = <span class="number">20</span></span><br><span class="line">    <span class="comment"># 最大下单资金比例</span></span><br><span class="line">    context.ratio = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 获取当天的日期</span></span><br><span class="line">    today = context.now</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取上一个交易日</span></span><br><span class="line">    last_day = get_previous_trading_date(exchange=<span class="string">&#x27;SHSE&#x27;</span>, date=today)</span><br><span class="line">    return_index = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取并计算行业指数收益率</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> context.index:</span><br><span class="line">        return_index_his = history_n(symbol=i, frequency=<span class="string">&#x27;1d&#x27;</span>, count=context.date, fields=<span class="string">&#x27;close,bob&#x27;</span>,</span><br><span class="line">                                     fill_missing=<span class="string">&#x27;Last&#x27;</span>, adjust=ADJUST_PREV, end_time=last_day, df=<span class="literal">True</span>)</span><br><span class="line">        return_index_his = return_index_his[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">        return_index.append(return_index_his[-<span class="number">1</span>] / return_index_his[<span class="number">0</span>] - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取指定数内收益率表现最好的行业</span></span><br><span class="line">    sector = context.index[np.argmax(return_index)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;最佳行业指数是: &#x27;</span>, sector)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取最佳行业指数成份股</span></span><br><span class="line">    symbols = get_history_constituents(index=sector, start_date=last_day, end_date=last_day)[<span class="number">0</span>][<span class="string">&#x27;constituents&#x27;</span>].keys()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当天有交易的股票</span></span><br><span class="line">    not_suspended_info = get_history_instruments(symbols=symbols, start_date=today, end_date=today)</span><br><span class="line">    not_suspended_symbols = [item[<span class="string">&#x27;symbol&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> not_suspended_info <span class="keyword">if</span> <span class="keyword">not</span> item[<span class="string">&#x27;is_suspended&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取最佳行业指数成份股的市值，从大到小排序并选取市值最大的5只股票</span></span><br><span class="line">    fin = get_fundamentals(table=<span class="string">&#x27;tq_sk_finindic&#x27;</span>, symbols=not_suspended_symbols, start_date=last_day,</span><br><span class="line">                           end_date=last_day, limit=<span class="number">5</span>, fields=<span class="string">&#x27;NEGOTIABLEMV&#x27;</span>, order_by=<span class="string">&#x27;-NEGOTIABLEMV&#x27;</span>, df=<span class="literal">True</span>)</span><br><span class="line">    fin.index = fin[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算权重</span></span><br><span class="line">    percent = <span class="number">1.0</span> / <span class="built_in">len</span>(fin.index) * context.ratio</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当前所有仓位</span></span><br><span class="line">    positions = context.account().positions()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如标的池有仓位,平不在标的池的仓位</span></span><br><span class="line">    <span class="keyword">for</span> position <span class="keyword">in</span> positions:</span><br><span class="line">        symbol = position[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> fin.index:</span><br><span class="line">            order_target_percent(symbol=symbol, percent=<span class="number">0</span>, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Long)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平不在标的池的&#x27;</span>, symbol)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对标的池进行操作</span></span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> fin.index:</span><br><span class="line">        order_target_percent(symbol=symbol, percent=percent, order_type=OrderType_Market,</span><br><span class="line">                             position_side=PositionSide_Long)</span><br><span class="line">        <span class="built_in">print</span>(symbol, <span class="string">&#x27;以市价单调整至仓位&#x27;</span>, percent)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">       backtest_start_time=<span class="string">&#x27;2017-07-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">10000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="机器学习-股票">机器学习(股票)</h2>
<h3 id="原理-17">原理</h3>
<h4 id="什么是机器学习？">什么是机器学习？</h4>
<p>随着计算机技术的发展，投资者不再只局限于传统投资策略，机器学习在资本市场得到广泛应用。机器学习的核心是通过机器模仿人类的思考过程以及思维习惯，通过对现有数据的学习，对问题进行预测和决策。目前，机器学习已在人脸识别、智能投顾、自然语言处理等方面得到广泛应用。</p>
<p>机器学习可以分为两类，一类是无监督学习，另一类是监督学习。监督学习是指按照已有的标记进行学习，即已经有准确的分类信息。比如二分类问题，一类是“好”，另一类是“不好”，这种明确地指出分类基准的问题。这类模型包括：神经网络、决策树、支持向量机等。</p>
<p>无监督学习是指针对未标记过的数据集进行学习。比如聚类问题，没有准确的标准说明应该聚成几类，只有相对概念。这类模型包括：K_means 聚类、层次聚类法等。</p>
<h4 id="什么是支持向量机？">什么是支持向量机？</h4>
<p>支持向量机是最典型的一类机器学习模型，常用于解决二分类问题。支持向量机的原理是在一个样本空间内，找到一个平面，将样本数据分为两个部分，即两个分类，这个平面就叫做超平面。</p>
<h4 id="利用支持向量机预测股票涨跌">利用支持向量机预测股票涨跌</h4>
<p>在利用支持向量机进行预测之前，先将数据集分为训练集和测试集。常用的分类方法是将数据及进行 8:2 分解，0.8 部分是训练集，0.2 部分是测试集。用训练集训练模型，再用测试集评价模型的准确率等指标。</p>
<p>在利用支持向量机预测时，还有很重要的一步是进行参数优化。SVM 的参数包括以下几个。</p>
<table>
<thead>
<tr>
<th>参数符号</th>
<th>参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>C</td>
<td>罚函数，错误项的惩罚系数，默认为 1。C 越大，对错误样本的惩罚力度越大，准确度越高但泛化能力越低（泛化能力是指拓展到测试集中的准确率）。C 越小，允许样本增加一点错误，使泛化能力提高。</td>
</tr>
<tr>
<td>Kernel</td>
<td>核函数，包括 linear(线型核函数)、poly(多项式核函数)、rbf(高斯核函数)、sigmod(sigmod 核函数)。</td>
</tr>
<tr>
<td>degree</td>
<td>当核函数选成多项式核函数时对应的阶数。</td>
</tr>
<tr>
<td>Gamma</td>
<td>核函数系数。</td>
</tr>
</tbody>
</table>
<h3 id="策略思路-8">策略思路</h3>
<p>第一步：获取原始数据，这里获取 2016-04-01 到 2017-07-30 的数据。</p>
<p>第二步：计算 SVM 模型的输入变量。</p>
<h3 id="策略代码-16">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> sklearn <span class="keyword">import</span> svm</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;请安装scikit-learn库和带mkl的numpy&#x27;</span>)</span><br><span class="line">    sys.exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">本策略选取了七个特征变量组成了滑动窗口长度为15天的训练集,随后训练了一个二分类(上涨/下跌)的支持向量机模型.</span></span><br><span class="line"><span class="string">若没有仓位则在每个星期一的时候输入标的股票近15个交易日的特征变量进行预测,并在预测结果为上涨的时候购买标的.</span></span><br><span class="line"><span class="string">若已经持有仓位则在盈利大于10%的时候止盈,在星期五损失大于2%的时候止损.</span></span><br><span class="line"><span class="string">特征变量为:1.收盘价/均值2.现量/均量3.最高价/均价4.最低价/均价5.现量6.区间收益率7.区间标准差</span></span><br><span class="line"><span class="string">训练数据为:SHSE.600000浦发银行,时间从2016-03-01到2017-06-30</span></span><br><span class="line"><span class="string">回测时间为:2017-07-01 09:00:00到2017-10-01 09:00:00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 订阅浦发银行的分钟bar行情</span></span><br><span class="line">    context.symbol = <span class="string">&#x27;SHSE.600000&#x27;</span></span><br><span class="line">    subscribe(symbols=context.symbol, frequency=<span class="string">&#x27;60s&#x27;</span>)</span><br><span class="line">    start_date = <span class="string">&#x27;2016-03-01&#x27;</span>  <span class="comment"># SVM训练起始时间</span></span><br><span class="line">    end_date = <span class="string">&#x27;2017-06-30&#x27;</span>  <span class="comment"># SVM训练终止时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于记录工作日</span></span><br><span class="line">    <span class="comment"># 获取目标股票的daily历史行情</span></span><br><span class="line">    recent_data = history(context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, start_time=start_date, end_time=end_date, fill_missing=<span class="string">&#x27;last&#x27;</span>,</span><br><span class="line">                          df=<span class="literal">True</span>)</span><br><span class="line">    days_value = recent_data[<span class="string">&#x27;bob&#x27;</span>].values</span><br><span class="line">    days_close = recent_data[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">    days = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取行情日期列表</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;准备数据训练SVM&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(days_value)):</span><br><span class="line">        days.append(<span class="built_in">str</span>(days_value[i])[<span class="number">0</span>:<span class="number">10</span>])</span><br><span class="line">    x_all = []</span><br><span class="line">    y_all = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>, (<span class="built_in">len</span>(days) - <span class="number">5</span>)):</span><br><span class="line">        <span class="comment"># 计算三星期共15个交易日相关数据</span></span><br><span class="line">        start_day = days[index - <span class="number">15</span>]</span><br><span class="line">        end_day = days[index]</span><br><span class="line">        data = history(context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, start_time=start_day, end_time=end_day, fill_missing=<span class="string">&#x27;last&#x27;</span>,</span><br><span class="line">                       df=<span class="literal">True</span>)</span><br><span class="line">        close = data[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">        max_x = data[<span class="string">&#x27;high&#x27;</span>].values</span><br><span class="line">        min_n = data[<span class="string">&#x27;low&#x27;</span>].values</span><br><span class="line">        amount = data[<span class="string">&#x27;amount&#x27;</span>].values</span><br><span class="line">        volume = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(close)):</span><br><span class="line">            volume_temp = amount[i] / close[i]</span><br><span class="line">            volume.append(volume_temp)</span><br><span class="line"></span><br><span class="line">        close_mean = close[-<span class="number">1</span>] / np.mean(close)  <span class="comment"># 收盘价/均值</span></span><br><span class="line">        volume_mean = volume[-<span class="number">1</span>] / np.mean(volume)  <span class="comment"># 现量/均量</span></span><br><span class="line">        max_mean = max_x[-<span class="number">1</span>] / np.mean(max_x)  <span class="comment"># 最高价/均价</span></span><br><span class="line">        min_mean = min_n[-<span class="number">1</span>] / np.mean(min_n)  <span class="comment"># 最低价/均价</span></span><br><span class="line">        vol = volume[-<span class="number">1</span>]  <span class="comment"># 现量</span></span><br><span class="line">        return_now = close[-<span class="number">1</span>] / close[<span class="number">0</span>]  <span class="comment"># 区间收益率</span></span><br><span class="line">        std = np.std(np.array(close), axis=<span class="number">0</span>)  <span class="comment"># 区间标准差</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将计算出的指标添加到训练集X</span></span><br><span class="line">        <span class="comment"># features用于存放因子</span></span><br><span class="line">        features = [close_mean, volume_mean, max_mean, min_mean, vol, return_now, std]</span><br><span class="line">        x_all.append(features)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 准备算法需要用到的数据</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(days_close) - <span class="number">20</span>):</span><br><span class="line">        <span class="keyword">if</span> days_close[i + <span class="number">20</span>] &gt; days_close[i + <span class="number">15</span>]:</span><br><span class="line">            label = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            label = <span class="number">0</span></span><br><span class="line">        y_all.append(label)</span><br><span class="line">    x_train = x_all[: -<span class="number">1</span>]</span><br><span class="line">    y_train = y_all[: -<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 训练SVM</span></span><br><span class="line">    context.clf = svm.SVC(C=<span class="number">1.0</span>, kernel=<span class="string">&#x27;rbf&#x27;</span>, degree=<span class="number">3</span>, gamma=<span class="string">&#x27;auto&#x27;</span>, coef0=<span class="number">0.0</span>, shrinking=<span class="literal">True</span>, probability=<span class="literal">False</span>,</span><br><span class="line">                          tol=<span class="number">0.001</span>, cache_size=<span class="number">200</span>, verbose=<span class="literal">False</span>, max_iter=-<span class="number">1</span>,</span><br><span class="line">                          decision_function_shape=<span class="string">&#x27;ovr&#x27;</span>, random_state=<span class="literal">None</span>)</span><br><span class="line">    context.clf.fit(x_train, y_train)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;训练完成!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_bar</span>(<span class="params">context, bars</span>):</span><br><span class="line">    bar = bars[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 获取当前年月日</span></span><br><span class="line">    today = bar.bob.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据并计算相应的因子</span></span><br><span class="line">    <span class="comment"># 于星期一的09:31:00进行操作</span></span><br><span class="line">    <span class="comment"># 当前bar的工作日</span></span><br><span class="line">    weekday = datetime.strptime(today, <span class="string">&#x27;%Y-%m-%d&#x27;</span>).isoweekday()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取模型相关的数据</span></span><br><span class="line">    <span class="comment"># 获取持仓</span></span><br><span class="line">    position = context.account().position(symbol=context.symbol, side=PositionSide_Long)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果bar是新的星期一且没有仓位则开始预测</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> position <span class="keyword">and</span> weekday == <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 获取预测用的历史数据</span></span><br><span class="line">        data = history_n(symbol=context.symbol, frequency=<span class="string">&#x27;1d&#x27;</span>, end_time=today, count=<span class="number">15</span>,</span><br><span class="line">                         fill_missing=<span class="string">&#x27;last&#x27;</span>, df=<span class="literal">True</span>)</span><br><span class="line">        close = data[<span class="string">&#x27;close&#x27;</span>].values</span><br><span class="line">        train_max_x = data[<span class="string">&#x27;high&#x27;</span>].values</span><br><span class="line">        train_min_n = data[<span class="string">&#x27;low&#x27;</span>].values</span><br><span class="line">        train_amount = data[<span class="string">&#x27;amount&#x27;</span>].values</span><br><span class="line">        volume = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(close)):</span><br><span class="line">            volume_temp = train_amount[i] / close[i]</span><br><span class="line">            volume.append(volume_temp)</span><br><span class="line">        close_mean = close[-<span class="number">1</span>] / np.mean(close)</span><br><span class="line">        volume_mean = volume[-<span class="number">1</span>] / np.mean(volume)</span><br><span class="line">        max_mean = train_max_x[-<span class="number">1</span>] / np.mean(train_max_x)</span><br><span class="line">        min_mean = train_min_n[-<span class="number">1</span>] / np.mean(train_min_n)</span><br><span class="line">        vol = volume[-<span class="number">1</span>]</span><br><span class="line">        return_now = close[-<span class="number">1</span>] / close[<span class="number">0</span>]</span><br><span class="line">        std = np.std(np.array(close), axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 得到本次输入模型的因子</span></span><br><span class="line">        features = [close_mean, volume_mean, max_mean, min_mean, vol, return_now, std]</span><br><span class="line">        features = np.array(features).reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">        prediction = context.clf.predict(features)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 若预测值为上涨则开仓</span></span><br><span class="line">        <span class="keyword">if</span> prediction == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 获取昨收盘价</span></span><br><span class="line">            context.price = close[-<span class="number">1</span>]</span><br><span class="line">            <span class="comment"># 把浦发银行的仓位调至95%</span></span><br><span class="line">            order_target_percent(symbol=context.symbol, percent=<span class="number">0.95</span>, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Long)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;SHSE.600000以市价单开多仓到仓位0.95&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 当涨幅大于10%,平掉所有仓位止盈</span></span><br><span class="line">    <span class="keyword">elif</span> position <span class="keyword">and</span> bar.close / context.price &gt;= <span class="number">1.10</span>:</span><br><span class="line">        order_close_all()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;SHSE.600000以市价单全平多仓止盈&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 当时间为周五并且跌幅大于2%时,平掉所有仓位止损</span></span><br><span class="line">    <span class="keyword">elif</span> position <span class="keyword">and</span> bar.close / context.price &lt; <span class="number">1.02</span> <span class="keyword">and</span> weekday == <span class="number">5</span>:</span><br><span class="line">        order_close_all()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;SHSE.600000以市价单全平多仓止损&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2017-07-01 09:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2017-10-01 09:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">10000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h2 id="小市值-股票">小市值(股票)</h2>
<h3 id="原理-18">原理</h3>
<h4 id="因子投资">因子投资</h4>
<p>提到量化策略，总是绕不开因子投资。自 CAPM 模型提出以来，因子投资不断发展壮大，成为市场广泛关注的领域。市面上的策略很大一部分都是基于各种各样的因子创造的，因子在股票和债券市场上的应用也取得了不小的成就。</p>
<p><strong>到底什么是因子投资?</strong></p>
<p>20 世纪 60 年代，资本资产定价模型（Capital Asset Pricing Model）提出，揭示了资产的预期收益率（预期超额收益率）与风险之间的关系，第一次给出了资本资产定价的直观表达式。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>−</mo><msub><mi>R</mi><mi>f</mi></msub><mo>=</mo><msub><mi>β</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>E</mi><mo stretchy="false">[</mo><msub><mi>R</mi><mi>M</mi></msub><mo stretchy="false">]</mo><mo>−</mo><msub><mi>R</mi><mi>f</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E[R_i] - R_f = \beta_i(E[R_M] - R_f)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">R_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 表示市场预期收益率，β 表示市场的风险暴露。</p>
<p>该公式指出资产的预期超额收益率由资产对市场风险的暴露大小决定，也就是说，资产的超额预期收益率可以完全由市场因子解释。</p>
<p>随着市场异象不断出现，人们发现资产的收益率并非只由市场因子决定，还受到其他因子的影响。1976 年，Ross 提出了无套利定价理论，构建了多因子定价模型，表达式为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msubsup><mi>R</mi><mi>i</mi><mi>ε</mi></msubsup><mo stretchy="false">]</mo><mo>=</mo><msub><mi>β</mi><mi>i</mi></msub><mi>λ</mi><mo>+</mo><msub><mi>α</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">E[R_i^{\varepsilon}] = \beta_i \lambda + \alpha_i
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ε</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中 λ 是因子预期收益率，β 是对应的因子暴露，α 表示误差项。</p>
<p>该公式指出资产的预期收益率是由一系列因子及其因子暴露加上误差项决定的。而因子投资的目的就是寻找到能够解释资产收益率的因子。</p>
<p><strong>既然资产预期收益率是由众多因子决定的，什么是因子？怎么寻找因子？</strong></p>
<p>根据《因子投资方法与实践》一书中的定义，“一个因子描述了众多资产共同暴露的某种系统性风险，该风险是资产收益率背后的驱动力，因子收益率正式这种系统性风险的风险溢价或风险补偿，它是这些资产的共性收益。”翻译过来就是，想要作为因子，必须能够解释多个资产的收益情况，并且能够带来正收益。</p>
<p>再来看式 2，可以发现，资产预期收益率是由两部分组成的，除了 λ 以外，还有一个 α 项，称之为误差项，表示资产预期收益率中 λ 无法解释的部分。α 的出现可能有以下两个原因，一种是因为模型设定错误，右侧遗漏了重要的因子；一种是由于选用样本数据可能存在一定偏差，导致在该样本数据下出现了 α 项。</p>
<p>为了确定 α 的出现是哪种原因，需要利用统计检验进行判断。</p>
<ul>
<li>如果 α 显著为零，说明 α 的出现只是偶然，并不能说明定价模型存在错误；</li>
<li>如果 α 显著不为零，说明资产预期收益里尚存在定价模型未能完全解释的部分。这种情况，就成为异象。</li>
</ul>
<p>因此，因子大体上可分为两种，一种是定价因子，也就是 λ 部分；一种是异象因子，也就是 α 部分。</p>
<h4 id="规模因子">规模因子</h4>
<p>1981 年 Banz 基于纽交所长达 40 年的数据发现，小市值股票月均收益率比其他股票高 0.4%。其背后的原因可能是投资者普遍不愿意持有小公司股票，使得这些小公司价格普遍偏低，甚至低于成本价，因此会有较高的预期收益率。由此产生了小市值策略，即投资于市值较小的股票。市值因子也被纳入进大名鼎鼎的 Fama 三因子模型和五因子模型之中。</p>
<p>A 股市场上规模因子是否有效？研究发现，2016 年以前，A 股市场上规模因子的显著性甚至超过了欧美等发达国家市场。但到了 2017-2018 年期间，大市值股票的表现明显优于小市值股票，使得规模因子在 A 股市场上的有效性存疑。</p>
<h3 id="策略逻辑-5">策略逻辑</h3>
<p>第一步：确定调仓频率，以每月第一天调仓为例</p>
<p>第二步：确定股票池股票数量，这里假设有 30 支</p>
<p>第三步：调仓日当天获取前一个月的历史数据，并按照市值由小到大排序</p>
<p>第四步：买入前 30 支股票</p>
<h3 id="策略代码-17">策略代码</h3>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">from</span> gm.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">小市值策略</span></span><br><span class="line"><span class="string">本策略每个月触发一次，计算当前沪深市场上市值最小的前30只股票，并且等权重方式进行买入。</span></span><br><span class="line"><span class="string">对于不在前30的有持仓的股票直接平仓。</span></span><br><span class="line"><span class="string">回测时间为：2018-07-01 08:00:00 到 2020-10-01 16:00:00</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 每月第一个交易日的09:40 定时执行algo任务（仿真和实盘时不支持该频率）</span></span><br><span class="line">    schedule(schedule_func=algo, date_rule=<span class="string">&#x27;1m&#x27;</span>, time_rule=<span class="string">&#x27;09:40:00&#x27;</span>)</span><br><span class="line">    <span class="comment"># 使用多少的资金来进行开仓。</span></span><br><span class="line">    context.ratio = <span class="number">0.8</span></span><br><span class="line">    <span class="comment"># 定义股票池数量</span></span><br><span class="line">    context.num = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="comment"># 获取筛选时间：date1表示当前日期之前的100天，date2表示当前时间</span></span><br><span class="line">    date1 = (context.now - timedelta(days=<span class="number">100</span>)).strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    date2 = context.now.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过get_instruments获取所有的上市股票代码</span></span><br><span class="line">    all_stock = get_instruments(exchanges=<span class="string">&#x27;SHSE, SZSE&#x27;</span>, sec_types=[<span class="number">1</span>], fields=<span class="string">&#x27;symbol, listed_date, delisted_date&#x27;</span>,</span><br><span class="line">                                df=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 剔除停牌和st股和上市不足100日的新股和退市股和B股</span></span><br><span class="line">    code = all_stock[(all_stock[<span class="string">&#x27;listed_date&#x27;</span>] &lt; date1) &amp; (all_stock[<span class="string">&#x27;delisted_date&#x27;</span>] &gt; date2) &amp;</span><br><span class="line">                     (all_stock[<span class="string">&#x27;symbol&#x27;</span>].<span class="built_in">str</span>[<span class="number">5</span>] != <span class="string">&#x27;9&#x27;</span>) &amp; (all_stock[<span class="string">&#x27;symbol&#x27;</span>].<span class="built_in">str</span>[<span class="number">5</span>] != <span class="string">&#x27;2&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取所有股票市值</span></span><br><span class="line">    fundamental = get_fundamentals_n(<span class="string">&#x27;trading_derivative_indicator&#x27;</span>, code[<span class="string">&#x27;symbol&#x27;</span>].to_list(),</span><br><span class="line">                                     context.now, fields=<span class="string">&#x27;TOTMKTCAP&#x27;</span>, order_by=<span class="string">&#x27;TOTMKTCAP&#x27;</span>, count=<span class="number">1</span>, df=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对市值进行排序（升序），并且获取前30个。 最后将这个series 转化成为一个list即为标的池</span></span><br><span class="line">    trade_symbols = fundamental.reset_index(drop=<span class="literal">True</span>).loc[:context.num - <span class="number">1</span>, <span class="string">&#x27;symbol&#x27;</span>].to_list()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;本次股票池有股票数目: &#x27;</span>, <span class="built_in">len</span>(trade_symbols))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算每个个股应该在持仓中的权重</span></span><br><span class="line">    percent = <span class="number">1.0</span> / <span class="built_in">len</span>(trade_symbols) * context.ratio</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取当前所有仓位</span></span><br><span class="line">    positions = context.account().positions()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 平不在标的池的仓位</span></span><br><span class="line">    <span class="keyword">for</span> position <span class="keyword">in</span> positions:</span><br><span class="line">        symbol = position[<span class="string">&#x27;symbol&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> trade_symbols:</span><br><span class="line">            order_target_percent(symbol=symbol, percent=<span class="number">0</span>, order_type=OrderType_Market,</span><br><span class="line">                                 position_side=PositionSide_Long)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;市价单平不在标的池的&#x27;</span>, symbol)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将标中已有持仓的和还没有持仓的都调整到计算出来的比例。</span></span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> trade_symbols:</span><br><span class="line">        order_target_percent(symbol=symbol, percent=percent, order_type=OrderType_Market,</span><br><span class="line">                             position_side=PositionSide_Long)</span><br><span class="line">        <span class="built_in">print</span>(symbol, <span class="string">&#x27;以市价单调整至权重&#x27;</span>, percent)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    strategy_id策略ID,由系统生成</span></span><br><span class="line"><span class="string">    filename文件名,请与本文件名保持一致</span></span><br><span class="line"><span class="string">    mode实时模式:MODE_LIVE回测模式:MODE_BACKTEST</span></span><br><span class="line"><span class="string">    token绑定计算机的ID,可在系统设置-密钥管理中生成</span></span><br><span class="line"><span class="string">    backtest_start_time回测开始时间</span></span><br><span class="line"><span class="string">    backtest_end_time回测结束时间</span></span><br><span class="line"><span class="string">    backtest_adjust股票复权方式不复权:ADJUST_NONE前复权:ADJUST_PREV后复权:ADJUST_POST</span></span><br><span class="line"><span class="string">    backtest_initial_cash回测初始资金</span></span><br><span class="line"><span class="string">    backtest_commission_ratio回测佣金比例</span></span><br><span class="line"><span class="string">    backtest_slippage_ratio回测滑点比例</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    run(strategy_id=<span class="string">&#x27;strategy_id&#x27;</span>,</span><br><span class="line">        filename=<span class="string">&#x27;main.py&#x27;</span>,</span><br><span class="line">        mode=MODE_BACKTEST,</span><br><span class="line">        token=<span class="string">&#x27;&#123;&#123;token&#125;&#125;&#x27;</span>,</span><br><span class="line">        backtest_start_time=<span class="string">&#x27;2005-01-01 08:00:00&#x27;</span>,</span><br><span class="line">        backtest_end_time=<span class="string">&#x27;2020-10-01 16:00:00&#x27;</span>,</span><br><span class="line">        backtest_adjust=ADJUST_PREV,</span><br><span class="line">        backtest_initial_cash=<span class="number">1000000</span>,</span><br><span class="line">        backtest_commission_ratio=<span class="number">0.0001</span>,</span><br><span class="line">        backtest_slippage_ratio=<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>量化分析经典策略总结</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.myquant.cn/docs/python_strategyies/">https://www.myquant.cn/docs/python_strategyies/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>掘金量化</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2021-06-10</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2022-08-19</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90/">量化分析</a><a class="post-meta__tags" href="/tags/%E7%BB%8F%E5%85%B8%E7%AD%96%E7%95%A5/">经典策略</a></div><div class="post_share"><div class="social-share" data-image="https://static.emoryhuang.cn/webp/3709186536-banner.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://static.emoryhuang.cn/webp/emoryhuang-wechat.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/emoryhuang-wechat.webp" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://static.emoryhuang.cn/webp/emoryhuang-alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/emoryhuang-alipay.webp" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/2717466625.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/2717466625-banner.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">思维工程学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/blog/1772203212.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/1772203212-banner.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">便利工具和网站分享</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blog/208450541.html" title="CTP 学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/208450541-banner.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-16</div><div class="title">CTP 学习笔记</div></div></a></div><div><a href="/blog/2222457050.html" title="量化分析因子研究"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/2222457050-banner.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-16</div><div class="title">量化分析因子研究</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Twikoo</span><span class="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/img/emoryhuang-avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">EmoryHuang</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">124</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">103</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/EmoryHuang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/EmoryHuang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:boyi_huang@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Welcome to my Blog!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">量化分析经典策略总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8F%B2%E9%98%BF%E9%87%8C%E5%9B%9B%E4%BB%B7-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.1.</span> <span class="toc-text">菲阿里四价(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.2.</span> <span class="toc-text">策略逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E5%9D%87%E7%BA%BF%E7%AD%96%E7%95%A5-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.2.</span> <span class="toc-text">双均线策略(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">1.2.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%87%E7%BA%BF%E7%90%86%E8%AE%BA%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E6%95%88%EF%BC%9F"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">均线理论为什么有效？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%87%E7%BA%BF%E7%90%86%E8%AE%BA%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">均线理论的缺陷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%87%E7%BA%BF%E7%90%86%E8%AE%BA%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">均线理论的改进</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E9%80%BB%E8%BE%91-2"><span class="toc-number">1.2.2.</span> <span class="toc-text">策略逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-2"><span class="toc-number">1.2.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dual-Thrust-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.3.</span> <span class="toc-text">Dual Thrust(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">1.3.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E9%80%BB%E8%BE%91-3"><span class="toc-number">1.3.2.</span> <span class="toc-text">策略逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-3"><span class="toc-number">1.3.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#R-Breaker-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.4.</span> <span class="toc-text">R-Breaker(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">1.4.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-5"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">触发条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%8C%E5%90%8E%E9%80%BB%E8%BE%91%E8%A7%A3%E6%9E%90"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">背后逻辑解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E9%80%BB%E8%BE%91-4"><span class="toc-number">1.4.2.</span> <span class="toc-text">策略逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-4"><span class="toc-number">1.4.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%83%E6%9E%97%E7%BA%BF%E5%9D%87%E5%80%BC%E5%9B%9E%E5%BD%92-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.5.</span> <span class="toc-text">布林线均值回归(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-6"><span class="toc-number">1.5.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF"><span class="toc-number">1.5.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-5"><span class="toc-number">1.5.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alpha-%E5%AF%B9%E5%86%B2-%E8%82%A1%E7%A5%A8-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.6.</span> <span class="toc-text">alpha 对冲(股票+期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-7"><span class="toc-number">1.6.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E4%B8%BA-alpha%EF%BC%9F"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">何为 alpha？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-alpha-%E5%AF%B9%E5%86%B2%E7%AD%96%E7%95%A5%EF%BC%9F"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">什么是 alpha 对冲策略？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E5%AF%B9%E5%86%B2%EF%BC%9F"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">怎么对冲？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E8%A6%81%E7%82%B9"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">策略要点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.2.</span> <span class="toc-text">策略实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-6"><span class="toc-number">1.6.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E6%A0%BC%E4%BA%A4%E6%98%93-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.7.</span> <span class="toc-text">网格交易(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-8"><span class="toc-number">1.7.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BD%91%E6%A0%BC%E4%BA%A4%E6%98%93%E6%B3%95%EF%BC%9F"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">什么是网格交易法？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E6%A0%B7%E8%AE%BE%E8%AE%A1%E7%BD%91%E6%A0%BC%EF%BC%9F"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">怎样设计网格？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">核心</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-2"><span class="toc-number">1.7.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-7"><span class="toc-number">1.7.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%9B%A0%E5%AD%90%E9%80%89%E8%82%A1-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.8.</span> <span class="toc-text">多因子选股(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-9"><span class="toc-number">1.8.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fama-French-%E4%B8%89%E5%9B%A0%E5%AD%90%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">Fama-French 三因子模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">策略设计思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.8.2.</span> <span class="toc-text">策略步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-8"><span class="toc-number">1.8.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E6%95%B0%E5%A2%9E%E5%BC%BA-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.9.</span> <span class="toc-text">指数增强(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-10"><span class="toc-number">1.9.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">1.9.2.</span> <span class="toc-text">策略步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-9"><span class="toc-number">1.9.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%93%81%E7%A7%8D%E5%A5%97%E5%88%A9-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.10.</span> <span class="toc-text">跨品种套利(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-11"><span class="toc-number">1.10.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E5%93%81%E7%A7%8D%E5%A5%97%E5%88%A9%EF%BC%9F"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">什么是跨品种套利？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">策略设计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-3"><span class="toc-number">1.10.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-10"><span class="toc-number">1.10.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%86%85%E5%9B%9E%E8%BD%AC%E4%BA%A4%E6%98%93-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.11.</span> <span class="toc-text">日内回转交易(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-12"><span class="toc-number">1.11.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%86%85%E5%9B%9E%E8%BD%AC%E4%BA%A4%E6%98%93"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">日内回转交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%82%A1%E7%A5%A8%E7%9A%84%E6%97%A5%E5%86%85%E5%9B%9E%E8%BD%AC%E4%BA%A4%E6%98%93"><span class="toc-number">1.11.1.2.</span> <span class="toc-text">股票的日内回转交易</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%8E%E6%A0%B7%E5%AF%B9%E8%82%A1%E7%A5%A8%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%86%85%E5%9B%9E%E8%BD%AC%E4%BA%A4%E6%98%93%EF%BC%9F"><span class="toc-number">1.11.1.2.1.</span> <span class="toc-text">怎样对股票进行日内回转交易？</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MACD-%E6%8C%87%E6%A0%87%E7%AE%80%E4%BB%8B"><span class="toc-number">1.11.1.3.</span> <span class="toc-text">MACD 指标简介</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-4"><span class="toc-number">1.11.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-11"><span class="toc-number">1.11.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9C%9F%E5%A5%97%E5%88%A9-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.12.</span> <span class="toc-text">跨期套利(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-13"><span class="toc-number">1.12.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E6%9C%9F%E5%A5%97%E5%88%A9%EF%BC%9F"><span class="toc-number">1.12.1.1.</span> <span class="toc-text">什么是跨期套利？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A5%97%E5%88%A9%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.1.2.</span> <span class="toc-text">套利方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E6%95%B4%E6%A3%80%E9%AA%8C"><span class="toc-number">1.12.1.3.</span> <span class="toc-text">协整检验</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">1.12.2.</span> <span class="toc-text">策略步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-12"><span class="toc-number">1.12.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%B7%E9%BE%9F%E4%BA%A4%E6%98%93%E6%B3%95-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.13.</span> <span class="toc-text">海龟交易法(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-14"><span class="toc-number">1.13.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%B7%E6%BA%90"><span class="toc-number">1.13.1.1.</span> <span class="toc-text">起源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E4%BB%93%E8%B5%84%E9%87%91"><span class="toc-number">1.13.1.2.</span> <span class="toc-text">建仓资金</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ATR"><span class="toc-number">1.13.1.2.1.</span> <span class="toc-text">ATR</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%B7%E5%80%BC%E6%B3%A2%E5%8A%A8%E9%87%8F"><span class="toc-number">1.13.1.2.2.</span> <span class="toc-text">价值波动量</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%B8%82%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.13.1.3.</span> <span class="toc-text">入市信号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E4%BB%93%E5%92%8C%E6%AD%A2%E6%8D%9F"><span class="toc-number">1.13.1.4.</span> <span class="toc-text">加仓和止损</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A2%E7%9B%88"><span class="toc-number">1.13.1.5.</span> <span class="toc-text">止盈</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-5"><span class="toc-number">1.13.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-13"><span class="toc-number">1.13.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9A%E5%B8%82%E5%95%86%E4%BA%A4%E6%98%93-%E6%9C%9F%E8%B4%A7"><span class="toc-number">1.14.</span> <span class="toc-text">做市商交易(期货)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-15"><span class="toc-number">1.14.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%9A%E5%B8%82%E5%95%86%E5%88%B6%E5%BA%A6"><span class="toc-number">1.14.1.1.</span> <span class="toc-text">做市商制度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-6"><span class="toc-number">1.14.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-14"><span class="toc-number">1.14.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%9A%E8%BD%AE%E5%8A%A8-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.15.</span> <span class="toc-text">行业轮动(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-16"><span class="toc-number">1.15.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E4%B8%9A%E8%BD%AE%E5%8A%A8%E7%8E%B0%E8%B1%A1"><span class="toc-number">1.15.1.1.</span> <span class="toc-text">行业轮动现象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E4%B8%9A%E8%BD%AE%E5%8A%A8%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.15.1.2.</span> <span class="toc-text">行业轮动的原因</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0-1%EF%BC%9A%E8%A1%8C%E4%B8%9A%E5%91%A8%E6%9C%9F"><span class="toc-number">1.15.1.2.1.</span> <span class="toc-text">原因 1：行业周期</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0-2%EF%BC%9A%E5%9B%BD%E5%AE%B6%E6%94%BF%E7%AD%96"><span class="toc-number">1.15.1.2.2.</span> <span class="toc-text">原因 2：国家政策</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0-3%EF%BC%9A%E9%87%8D%E5%A4%A7%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.15.1.2.3.</span> <span class="toc-text">原因 3：重大事件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E4%B8%9A%E8%BD%AE%E5%8A%A8%E4%B8%8B%E8%B5%84%E4%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">1.15.1.3.</span> <span class="toc-text">行业轮动下资产配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1-2"><span class="toc-number">1.15.1.3.1.</span> <span class="toc-text">策略设计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-7"><span class="toc-number">1.15.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-15"><span class="toc-number">1.15.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.16.</span> <span class="toc-text">机器学习(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-17"><span class="toc-number">1.16.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%EF%BC%9F"><span class="toc-number">1.16.1.1.</span> <span class="toc-text">什么是机器学习？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA%EF%BC%9F"><span class="toc-number">1.16.1.2.</span> <span class="toc-text">什么是支持向量机？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA%E9%A2%84%E6%B5%8B%E8%82%A1%E7%A5%A8%E6%B6%A8%E8%B7%8C"><span class="toc-number">1.16.1.3.</span> <span class="toc-text">利用支持向量机预测股票涨跌</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%80%9D%E8%B7%AF-8"><span class="toc-number">1.16.2.</span> <span class="toc-text">策略思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-16"><span class="toc-number">1.16.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E5%B8%82%E5%80%BC-%E8%82%A1%E7%A5%A8"><span class="toc-number">1.17.</span> <span class="toc-text">小市值(股票)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-18"><span class="toc-number">1.17.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%A0%E5%AD%90%E6%8A%95%E8%B5%84"><span class="toc-number">1.17.1.1.</span> <span class="toc-text">因子投资</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E6%A8%A1%E5%9B%A0%E5%AD%90"><span class="toc-number">1.17.1.2.</span> <span class="toc-text">规模因子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E9%80%BB%E8%BE%91-5"><span class="toc-number">1.17.2.</span> <span class="toc-text">策略逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E4%BB%A3%E7%A0%81-17"><span class="toc-number">1.17.3.</span> <span class="toc-text">策略代码</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/708003372.html" title="【论文阅读】DisenPOI Disentangling sequential and geographical influence for point-of-interest recommendation"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/708003372-banner.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【论文阅读】DisenPOI Disentangling sequential and geographical influence for point-of-interest recommendation"/></a><div class="content"><a class="title" href="/blog/708003372.html" title="【论文阅读】DisenPOI Disentangling sequential and geographical influence for point-of-interest recommendation">【论文阅读】DisenPOI Disentangling sequential and geographical influence for point-of-interest recommendation</a><time datetime="2023-03-11T04:32:49.000Z" title="发表于 2023-03-11 12:32:49">2023-03-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2762303743.html" title="使用 LaTeX 进行论文写作"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/2762303743-banner.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 LaTeX 进行论文写作"/></a><div class="content"><a class="title" href="/blog/2762303743.html" title="使用 LaTeX 进行论文写作">使用 LaTeX 进行论文写作</a><time datetime="2023-03-01T07:13:20.000Z" title="发表于 2023-03-01 15:13:20">2023-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/683141325.html" title="使用 PyG 进行图神经网络训练"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/683141325-banner.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 PyG 进行图神经网络训练"/></a><div class="content"><a class="title" href="/blog/683141325.html" title="使用 PyG 进行图神经网络训练">使用 PyG 进行图神经网络训练</a><time datetime="2022-11-09T03:12:05.000Z" title="发表于 2022-11-09 11:12:05">2022-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/1329760803.html" title="【论文阅读】ST-PIL: Spatial-Temporal Periodic Interest Learning for Next Point-of-Interest Recommendation"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/1329760803-banner.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【论文阅读】ST-PIL: Spatial-Temporal Periodic Interest Learning for Next Point-of-Interest Recommendation"/></a><div class="content"><a class="title" href="/blog/1329760803.html" title="【论文阅读】ST-PIL: Spatial-Temporal Periodic Interest Learning for Next Point-of-Interest Recommendation">【论文阅读】ST-PIL: Spatial-Temporal Periodic Interest Learning for Next Point-of-Interest Recommendation</a><time datetime="2022-10-10T03:16:56.000Z" title="发表于 2022-10-10 11:16:56">2022-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2631345981.html" title="【论文阅读】Next point-of-interest recommendation with auto-correlation enhanced
 multi-modal transformer network"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.emoryhuang.cn/webp/2631345981-banner.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【论文阅读】Next point-of-interest recommendation with auto-correlation enhanced
 multi-modal transformer network"/></a><div class="content"><a class="title" href="/blog/2631345981.html" title="【论文阅读】Next point-of-interest recommendation with auto-correlation enhanced
 multi-modal transformer network">【论文阅读】Next point-of-interest recommendation with auto-correlation enhanced
 multi-modal transformer network</a><time datetime="2022-10-08T07:10:43.000Z" title="发表于 2022-10-08 15:10:43">2022-10-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://static.emoryhuang.cn/webp/3709186536-banner.webp')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By EmoryHuang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://icp.gov.moe" target="_blank">萌ICP备 </a><a href="https://icp.gov.moe/?keyword=20215281" target="_blank"> 20215281号</a> | <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备2022000821号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000)
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.emoryhuang.cn/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.emoryhuang.cn/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo@1/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'bcNDuLTWy0iRRePdlkOpKSve-gzGzoHsz',
      appKey: 'yTSKpRCVBDa8gyFQLEuSp0B2',
      avatar: 'monsterid',
      serverURLs: 'https://bcndultw.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Twikoo' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script><script async src="/js/grayscale.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-8PVDZZ1XD2', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://github-calendar-api-emoryhuang.vercel.app/api?emoryhuang";
            var git_color =['#ebedf0', '#f0fff4', '#dcffe4', '#bef5cb', '#85e89d', '#34d058', '#28a745', '#22863a', '#176f2c', '#165c26', '#144620'];
            var git_user ="emoryhuang";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>